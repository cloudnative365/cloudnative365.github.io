<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>常见监控系统和适用场景 | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="常见监控系统和适用场景" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L4_architect_2_monitoring_5_common_monitor_system.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L4_architect_2_monitoring_5_common_monitor_system.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"常见监控系统和适用场景","url":"http://localhost:4000/keynotes_L4_architect_2_monitoring_5_common_monitor_system.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="学习目标">学习目标</h2>

<p>知道企业中，什么系统需要被监控</p>

<p>了解常见的需要上监控的系统</p>

<p>挑选合适的软件来监控</p>

<p>常见的监控指标</p>

<h2 id="1-简介">1. 简介</h2>

<p>在工作中，企业内部的一切IT相关系统都可以被监控，但是真正要被监控的其实是领导或者客户提出的那些项，所以说，沟通很重要，一定要了解领导或者客户的要求再开始架构系统。我们架构系统的时候，要从上到下开始思考整个架构，然后从下到上，一步步满足客户的要求。</p>

<h2 id="2-从上到下思考整个架构">2. 从上到下思考整个架构</h2>

<p>这里包含下面几个问题</p>

<ul>
  <li>什么系统需要监控？</li>
  <li>使用什么软件来监控？</li>
  <li>监控软件应该使用怎样的结构才能满足要求？</li>
  <li>常见的监控指标</li>
  <li>性能调优</li>
</ul>

<h3 id="21-什么系统需要监控">2.1. 什么系统需要监控</h3>

<p>一般来说，运维工程师常见的，需要被监控的系统有</p>

<ul>
  <li>物理机：这里面有两个部分，一个是操作系统，一个是管理控制台（HP-ILO，IBM PC-AMM，IBM小型机-HMC）</li>
  <li>虚拟机：有三个部分，一个是虚拟出来的Host，一个是hypervisor的软件（比如vmware-vSphere，redhat-ovirt），最后同样需要监控管理控制台</li>
  <li>公有云主机：基本上每个公有云供应商都会提供一套监控，但是略微有差别，比如AWS默认是不会在系统中装agent的，所以如果不手动安装agent，监控的指标是有限的，但是像阿里云，默认是在系统中装agent的，所以监控指标比较全面</li>
  <li>存储设备：如果是使用分布式存储，比如ceph之类的，可以按照监控主机和监控应用一样来对待。如果使用的是存储设备，比如3PAR，HPE或者IBM-DS之类的存储，那么就需要在选购存储的时候，把监控的问题考虑进去，因为存储其实是一个定制化的操作系统带一些特殊的raid卡，然后插满磁盘组成的，所以操作系统上可不可以安装agent或者是不是能暴露一些metrics就成了监控的关键。</li>
  <li>网络设备：一般来说，网络设备是无法安装agent的，我们想要监控就需要使用snmp协议对网络设备进行监控，当然，也有一些高端设备是自带监控api的，可以使用一些软件去采集。</li>
  <li>容器/编排工具的监控：对于这种动态的系统，我们监控的时候就需要考虑到我们的监控系统也应该是适用于动态环境下的监控。pod是随时销毁和创建的，如果我们手动安装agent，那么这对于运维来说，绝对是最痛苦的。</li>
  <li>工具的监控：这里说的主要是指公司内部的系统，比如DevOps系统（jenkins，gitlab，harbor）和办公系统（Sap系统，office系统，邮件系统）</li>
  <li>应用的监控：这应该是最难的一部分，这涉及到了4个黄金指标中的3项，延迟，错误率，流量。延迟是说系统的响应速度，错误率是说响应的错误率，流量是说QPS之类的逻辑指标。</li>
</ul>

<h3 id="22-需要什么软件来监控">2.2. 需要什么软件来监控</h3>

<p>这一部分其实是最能体现工程师的水平的，没有一款开园软件是适合所有场景的，如果我们不想自己开发，那么可能在整个的系统中会用到非常多的监控。但是，首先我们先要了解为什么使用它。就好像你要求找老板申请budget，老板一定会问你why？如果想要你的方案被采纳，就一定要告诉别人way！这其中我做了下面几个场景的总结。</p>

<ul>
  <li>从网络来说，我们把软件分为pull和push模型，也就是服务器是主动找目标要资源，还是说目标主动把资源送过来。因为我们的生产环境基本都有防火墙，所以如果想使用pull的模式，就需要在防火墙上开端口。如果不开端口，我们可以考虑push的模式，让目标主动汇报自己的情况。但是这又有了另外一个问题，如果目标节点挂了，它就没办法push了，而一般的系统为了防止误报，都会有多次的重试，这样就会导致问题发现的不及时。</li>
  <li>从协议来说，我们分为有agent和无agent的模型。有agent的，又分为http，tcp协议的。http一般是暴露metrics的方式，而tcp协议的一般都是C/S模型，监控软件自己基于tcp模型进行通信。无agent的，一般采用的都是snmp协议。</li>
  <li>从动静来说，对于虚拟机这种不经常变动的目标，我们会采用脚本安装，或者初始化参数中写入一些命令来安装agent。但是对于k8s之上的一些容器，如果使用脚本或者初始化参数来安装agent，不仅会影响k8s的敏捷性，还会给系统带来不小的压力，我们就需要使用一些轻量级的，可以随时内部读取k8s状态的监控。</li>
  <li>从展示图像来说，当然越漂亮越好，但是大部分监控软件自带的展示界面都丑爆了，比如我们前面说过的prometheus。而有些软件图像比较漂亮，但是只能支持自己的监控系统，没法集成多个系统。其实领导或者客户更希望一眼可以看到所有系统的状态，即使我们使用多个监控，展示的时候，还是尽量统一。</li>
  <li>从花钱角度来说，我们要了解监控系统的社区版和商业版有什么不同，比如：Influxdb的单机版不支持集群，nagios的单机版不支持mysql数据库</li>
</ul>

<h3 id="23-监控软件架构">2.3. 监控软件架构</h3>

<p>选好了监控软件，就需要设计架构了。我总结的架构设计原则有</p>

<ul>
  <li>高可用，支持分布式，多节点数据可同步</li>
  <li>可备份数据，可归档数据，最好支持读写分离</li>
  <li>agent要轻量，少占资源</li>
  <li>接口要丰富，可以和其他系统集成</li>
  <li>展示界面统一</li>
  <li>管理简便，特别是升级agent的时候</li>
  <li>支持自动化，自动化升级，自动化部署</li>
</ul>

<h3 id="24-比较常用的架构">2.4. 比较常用的架构</h3>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/5_normal_metrics/默认文件1594914906592.jpg" alt="默认文件1594914906592" style="zoom: 33%;" /></p>

<p>这个架构是一个比较理想的状态。右侧的这些基本都是或者自带监控平台，由于一些网络原因，或者兼容性原因，他们自身的平台是不可以跨平台，或者说一些软件只适用于某些场景，所以我们没必要使用一种软件监控所有的系统。但是，我们展示的时候还是希望能够统一界面，尽量满足最终用户（比如老板，开发，或者一线oncall人员）的体验，做到所见即所得。另外一个问题，也是目前没有太好的解决方案的问题就是报警平台。目前没有非常合适的开源报警工具，一些比较知名的工具，比如pageduty之类，都是需要额外收费的，所以基本上，报警还都是使用右侧各自工具的报警功能来做的。</p>

<h3 id="25-常见的监控指标">2.5. 常见的监控指标</h3>

<p>我们后面单独用一个篇幅来说这个问题</p>

<h3 id="26-性能调优">2.6. 性能调优</h3>

<p>调优其实并没有什么定律，调的意思就是试，大到每个环境，中到每个版本，小到一个参数，都会影响整体的性能。我们需要抓住两个点。</p>

<ul>
  <li>针对架构调优。每种软件，或者每个解决方案的架构都是不一样的，我们调优的时候，就需要找到瓶颈。具体来说，就是针对系统中用到的软件，或者硬件调优，比如：网络，磁盘，CPU，内存；数据库，web应用，后端服务，agent等等。这些都有可能出现问题，需要我们调理。</li>
  <li>针对固定参数调优。这个就需要了解整个软件的工作原理，比如：采用pull/push的方式时候的时间间隔，报警的时候的过滤规则。</li>
</ul>

<p>监控系统的调优并不仅仅是指针对于响应速度的调优，还有客户体验的调优，比如，警报没有被及时处理，是否需要不停的报告；或者用户针对某个dashboard需要有钻取的功能，就是说，点击某个业务的监控之后，可以链接到另外一个页面，能够展示业务所关联的服务器的状态。这些都应该算是监控调优的一部分，而这些都是需要我们在熟练掌握了多种软件的使用的前提下才能做到的。</p>

<h2 id="3-从上到下思考整个架构">3. 从上到下思考整个架构</h2>

<p>这里面包含下面几个问题</p>

<ul>
  <li>客户要我们监控什么指标？</li>
  <li>客户要求我们的监控做成什么样子？</li>
  <li>我们可以监控哪些指标？</li>
  <li>监控这些指标需要哪些条件？</li>
  <li>使用什么软件能够轻松的实现客户要求</li>
  <li>不同的软件如何集成在一起</li>
  <li>怎样降低管理的复杂度</li>
</ul>

<h3 id="31-客户要我们监控什么指标">3.1. 客户要我们监控什么指标</h3>

<p>这里的客户从四个角度来说</p>

<ul>
  <li>业务部门。他们可能只需要某一个，或者某几个业务指标，比如：订单量，页面点击量。一般他们的需求比较明确，但是一般来说，都没有现成的模板可用，都需要额外开发，比如：查询数据库，获得订单数，然后展示出来。</li>
  <li>开发部门。他们的要求多而且散，因为他们关心的是整个系统或者整个功能的可用性，而为了实现某个功能，可以需要多个软件，比如：前端的web，后台，数据库都需要监控，而且，他们之前的连通性也需要监控。通常，运维工程师并不是非常熟悉业务，这个时候，最好的方式，就是给他们权限，自己去做。但是，我要说的是，好的运维人员也需要了解业务，就好像好的开发人员要了解系统一样。</li>
  <li>运维部门。他们可能更加关心的是具体的某个指标，比如：CPU使用率，内存使用率，网络是否在某个时间段不通，这样有利于定位系统问题。但是，一个问题可能会影响多个维度，比如：网络不通之后，软件和软件通信会中断，如果代码内没有做处理，会导致瞬间有很多session在wait，导致内存或者CPU使用率过高。这个时候，我们可能需要从多个角度去分析问题，这个时候，如果能把有问题的部分都放到一张图来展示的话，就可以非常清晰的看到问题所在。</li>
  <li>领导。领导基本都是结果导向的，他们会从上到下的来看待问题，他们更希望一览众山小，一眼看到所有的系统的情况，这个时候，就需要非常清晰的dashboard让领导知道目前的情况。</li>
</ul>

<p>不通的客户的着眼点是不一样的，所以我们一定要先确定客户，以及他们的关注点。</p>

<h3 id="32-客户要求我们的监控做成什么样子">3.2. 客户要求我们的监控做成什么样子？</h3>

<p>我们也要从四个方面来说</p>

<ul>
  <li>展示。客户要看到什么样的图，是饼图还是线图，还是说只要一个数。这个直接影响着我们的查询语句。</li>
  <li>报警。什么应该报，什么不应该报，应该报给谁，通过什么报（微信，邮件）。</li>
  <li>附加功能。比如我们刚才提到的，如果某个系统出了问题，我们只要点击红色的报警就可以直接定位到问题所在。</li>
  <li>流程。我们报警之后谁来处理，谁来回复，如果出现问题，我们是应该先提change，还是先解决问题。</li>
</ul>

<p>满足客户的要求是我们工作的重点，一定要先确定工作范围，在完成指定的工作后再发挥，否则适得其反。</p>

<h3 id="33-我们可以监控哪些指标">3.3. 我们可以监控哪些指标</h3>

<p>我们通常会使用一些软件自带的模板或者别人开发好的模板作为基础做一些定制化修改。当然，如果有开发能力的话，是完全可以做成自己想要的样子。但是我们使用开源软件的原因就是减少开发成本，我们只需要做一些脚本级别的开发就可以满足客户需求。</p>

<p>我们后面会对一些常见指标进行详细说明。</p>

<h3 id="34-监控这些指标需要哪些条件">3.4. 监控这些指标需要哪些条件</h3>

<p>这里说的条件，主要是根据环境的不同而需要预先考虑的问题，比如：查询数据库的用户名和密码，为了访问某个特定指标，需要在网络上开端口。</p>

<ul>
  <li>从软件角度考虑。被监控的目标是否会暴露指标，或者API供外部软件去采集。如果没有暴露指标，我们可不可以在目标设备上安装一些探针去采集指标。</li>
  <li>从环境角度考虑。这些指标可以不可以被送达到服务器端，其实这个更多的是网络的因素。</li>
  <li>从合规角度考虑。因为有些情况下，还要符合安全或者合规的要求。比如：在中国的法律中要求我们的信息是不可以送到国外去的；或者一些等保要求等等。而最多的还是安全传输，这就涉及到了SSL证书，就是签署证书的机构和证书有效期问题。</li>
</ul>

<h3 id="35-使用什么软件能够轻松的实现客户要求">3.5. 使用什么软件能够轻松的实现客户要求</h3>

<p>我们还是比较提倡使用开源工具，如果一定要花钱，就去买服务好了。这个时候，我们架构师的水平就完全体现了出来，见多识广的人总是有非常好的建议，踩过坑的人才能更好的避开我们可能会遇到的问题。</p>

<p>如果有条件的公司建议自己开发监控系统，因为监控系统和资产管理系统可以作为一个整体的平台集成在一起，或者使用开源软件作为框架，然后自己定制一下，这样就能不用重复的造轮子了。</p>

<h3 id="36-不同的软件如何集成在一起">3.6. 不同的软件如何集成在一起</h3>

<p>google一下两个软件，会有很多的解决方案。千万不要用baidu或者bing，查出来的基本没有用。然后去官方文档确认，越成熟的软件兼容性越好，但是还是请大家要上手试一试，毕竟没有软件是万能的，好不好，坑不坑，试过才知道。</p>

<h3 id="37-怎样降低管理的复杂度">3.7. 怎样降低管理的复杂度</h3>

<p>这里有两个方面的复杂度</p>

<ul>
  <li>一个是管理端的，比如数据库的管理，后端监控服务的管理，包括扩展节点，数据备份，权限管理等等。</li>
  <li>另外一个是客户端的，比如那些需要安装agent的虚拟机或者物理机。想想一下，在一个拥有上万个agent的环境中，如果有一天安全部门要求运维部门每个月都要升级这些agent，那么如果没有合理的管理方式，那么这将会是灾难性的工作。</li>
</ul>

<p>我们降低复杂度也有两个方面</p>

<ul>
  <li>一个是管理软件的复杂度，比如升级，安装，删除等等。这就需要我们自动化的去做这些事情。我们通常会使用一些自动化工具，比如ansible或者镜像注入等方式来管理agent。</li>
  <li>另外一个是流程的复杂度，比如申请权限等等，我们通常会把权限交给ad来集成，这样就不用独立维护一套认证系统。即使是本地认证，在大规模应用的情况下还是非常难以维护。</li>
</ul>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
