<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>日志系统概述 | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="日志系统概述" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L4_architect_3_logging_3_install_plugins.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L4_architect_3_logging_3_install_plugins.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"日志系统概述","url":"http://localhost:4000/keynotes_L4_architect_3_logging_3_install_plugins.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="学习目标">学习目标</h2>

<p>安装安全插件SearchGuard</p>

<h2 id="1-安装searchguard">1. 安装SearchGuard</h2>

<p>在早期的ES版本（6.2之前）中，使用的认证插件是X-pack，这是一个官方的插件，但是在v6.2之后，ES自己支持了安全认证功能，但是要购买license。而另外一个比较知名的安全插件就是我们今天要说的SearchGuard了。</p>

<h3 id="11-安装searchguard-for-es">1.1. 安装SearchGuard for ES</h3>

<ul>
  <li>
    <p>SearchGuard的<a href="https://search-guard.com/">官方网站</a>，<a href="https://docs.search-guard.com/latest/">官方文档</a>，<a href="https://docs.search-guard.com/latest/search-guard-versions">下载地址</a>，demo文档</p>
  </li>
  <li>
    <p>下载页面上的版本和ES的版本基本对应，但是对于非常新的版本可能会有一定延迟</p>

    <p><img src="/pages/keynotes/L4_architect/3_logging/pics/3_install_plugins/image-20200826100253036.png" alt="image-20200826100253036" /></p>
  </li>
  <li>
    <p>安装：</p>

    <p>在线安装</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./bin/elasticsearch-plugin install com.floragunn:search-guard-7:7.8.1-43.0 
</code></pre></div>    </div>

    <p>离线安装</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 下载Zip包，一共有三种下载，我们选Search Guard，里面包含了所有POC时候用到的包，如果不想试用，可以直接下载第二个Search Guard Admin</span>
./bin/elasticsearch-plugin install <span class="nt">-b</span> file:///path/to/search-guard-suite-plugin-7.8.1-43.0.0.zip
</code></pre></div>    </div>
  </li>
  <li>
    <p>demo installer</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 切换到Elasticsearc的安装目录</span>
<span class="nb">cd</span> ./plugins/search-guard-7/tools
<span class="c"># 修改权限</span>
chmod 755 ./install_demo_configuration.sh
<span class="c"># 运行命令</span>
./install_demo_configuration.sh
<span class="c"># 问到下面的问题的时候，按照这个回答</span>
Install demo certificates? <span class="o">[</span>y/N] y
Initialize Search Guard? <span class="o">[</span>y/N] y
Enable cluster mode? <span class="o">[</span>y/N] n
</code></pre></div>    </div>
  </li>
  <li>
    <p>完成后，会在elasticsearch.yml文件中增加下面几行</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">######## Start Search Guard Demo Configuration ########</span>
<span class="c"># WARNING: revise all the lines below before you go into production</span>
searchguard.ssl.transport.pemcert_filepath: esnode.pem
searchguard.ssl.transport.pemkey_filepath: esnode-key.pem
searchguard.ssl.transport.pemtrustedcas_filepath: root-ca.pem
searchguard.ssl.transport.enforce_hostname_verification: <span class="nb">false
</span>searchguard.ssl.http.enabled: <span class="nb">true
</span>searchguard.ssl.http.pemcert_filepath: esnode.pem
searchguard.ssl.http.pemkey_filepath: esnode-key.pem
searchguard.ssl.http.pemtrustedcas_filepath: root-ca.pem
searchguard.allow_unsafe_democertificates: <span class="nb">true
</span>searchguard.allow_default_init_sgindex: <span class="nb">true
</span>searchguard.authcz.admin_dn:
  - <span class="nv">CN</span><span class="o">=</span>kirk,OU<span class="o">=</span>client,O<span class="o">=</span>client,L<span class="o">=</span><span class="nb">test</span>, <span class="nv">C</span><span class="o">=</span>de
  
searchguard.audit.type: internal_elasticsearch
searchguard.enable_snapshot_restore_privilege: <span class="nb">true
</span>searchguard.check_snapshot_restore_write_privileges: <span class="nb">true
</span>searchguard.restapi.roles_enabled: <span class="o">[</span><span class="s2">"SGS_ALL_ACCESS"</span><span class="o">]</span>
cluster.routing.allocation.disk.threshold_enabled: <span class="nb">false
</span>cluster.name: searchguard_demo
node.max_local_storage_nodes: 3
xpack.security.enabled: <span class="nb">false</span>
<span class="c">######## End Search Guard Demo Configuration ########</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>测试</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 启动ES</span>
systemctl start elasticsearch
<span class="c"># 测试HTTPS</span>
curl <span class="nt">-k</span> https://localhost:9200/_searchguard/authinfo?pretty
<span class="c"># 如果使用浏览器就需要接受一下自签证书</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>登录界面的时候使用admin/admin登录</p>
  </li>
</ul>

<h3 id="12-安装searchguard-for-kibana">1.2. 安装SearchGuard for Kibana</h3>

<ul>
  <li>
    <p>下载kibana插件，<a href="https://docs.search-guard.com/latest/search-guard-versions">下载地址</a>，同样需要版本对应</p>
  </li>
  <li>
    <p>安装</p>

    <p>在线安装：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/kibana-plugin install https://url/to/search-guard-kibana-plugin-&lt;version&gt;.zip 
</code></pre></div>    </div>

    <p>下载安装：</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/kibana-plugin install file:///path/to/search-guard-kibana-plugin-&lt;version&gt;.zip
</code></pre></div>    </div>
  </li>
  <li>
    <p>完成后修改/etc/kibana/kibana.yml</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Use HTTPS instead of HTTP</span>
elasticsearch.hosts: <span class="s2">"https://localhost:9200"</span>
  
<span class="c"># Configure the Kibana internal server user</span>
elasticsearch.username: <span class="s2">"kibanaserver"</span>
elasticsearch.password: <span class="s2">"kibanaserver"</span>
  
<span class="c"># Disable SSL verification because we use self-signed demo certificates</span>
elasticsearch.ssl.verificationMode: none
  
<span class="c"># Whitelist the Search Guard Multi Tenancy Header</span>
elasticsearch.requestHeadersWhitelist: <span class="o">[</span> <span class="s2">"Authorization"</span>, <span class="s2">"sgtenant"</span> <span class="o">]</span>
  
<span class="c"># X-Pack security needs to be disabled for Search Guard to work properly</span>
xpack.security.enabled: <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动kibana，这次启动时间比较长，kibana会把search guard的配置文件（<Elasticsearch directory="">/plugins/search-guard-7/sgconfig）都加载到elasticsearch中，在elasticsearch中就可以看到一个叫SearchGuard的索引</Elasticsearch></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start kibana
</code></pre></div>    </div>

    <ul>
      <li>PS：如果不使用kibana，我们就需要使用命令来让demo生效<Elasticsearch directory="">/plugins/search-guard-7/tools/sgadmin_demo.sh</Elasticsearch></li>
    </ul>
  </li>
  <li>
    <p>登录 http://localhost:5601/就会看到界面了，使用admin/admin登录</p>

    <p><img src="/pages/keynotes/L4_architect/3_logging/pics/3_install_plugins/image-20200826105021300.png" alt="image-20200826105021300" /></p>
  </li>
</ul>

<h3 id="13-search-guard-gui">1.3. Search Guard GUI</h3>

<p>我们可以通过三种方式来管理SearchGuard，sgadmin命令行，REST API和Kibana上面的图形界面。当然，最简便的方式还是图形界面了，他可以配置，用户，角色和权限。点击左上角的展开图标。</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/3_install_plugins/image-20200826105845354.png" alt="image-20200826105845354" /></p>

<p>选择Search Guard Configuration出现配置界面</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/3_install_plugins/image-20200826105939540.png" alt="image-20200826105939540" /></p>

<p>在新版中，我们看到还有一个选项叫<code class="highlighter-rouge">Search Guard Signals</code>，这是新的报警功能。目前7.8.1版本只有Email，slack，Jira和pageduty几种报警方式</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/3_install_plugins/image-20200826110912773.png" alt="image-20200826110912773" /></p>

<h3 id="14-概念">1.4. 概念</h3>

<ul>
  <li>Internal Users database：本地的账户。SG是支持其他认证方式的，比如LDAP等，详细配置看<a href="https://docs.search-guard.com/latest/demo-installer">这个</a>。在sg里面的认证（authentication）简称authc，授权（authoriztion）叫authz</li>
  <li>Tenants：相当于Openstack-M版中的租户或者R版中的project，AWS中的账户和子账户，confluence中的user space。多租户功能是收费的，免费的只能使用admin一个租户</li>
  <li>Action Group：实际上就是组的概念，不过SG内置了很多的SGS开头的权限组，而action group就是把它们组合在一起，而这些权限又分为cluster，index和single级别。single级别就是针对某个文档或者字段的控制了，这个是收费功能。</li>
  <li>Role：角色需要分别定义集群级别的，索引级别的，租户级别的权限，每个级别下面会有一个滑动按钮，叫<code class="highlighter-rouge">Advanced</code>点开就会出现一些细粒度的授权，这个里面的功能全部都是收费的。</li>
  <li>Role mapping：由于角色和用户是多对多的关系，所以这里增加了一个Role mapping，把一个角色分配给很多的用户，而<code class="highlighter-rouge">Internal Users database</code>是把很多角色分配给一个用户。</li>
</ul>

<h3 id="15-demo">1.5. Demo</h3>

<h4 id="151-demo-1官方demo中提供的一些用户和权限">1.5.1. Demo 1：官方demo中提供的一些用户和权限</h4>

<p>我们在运行了Demo脚本之后，会提供一些用户和权限，我们先来看看他们</p>

<ul>
  <li>
    <p>打开图形界面，点击<code class="highlighter-rouge">Search Guard Configuration</code>–&gt; <code class="highlighter-rouge">Internal Users database</code>，我们可以看到非常多的用户</p>
  </li>
  <li>
    <p>kibanaserver：我们在配置kibana的时候，使用的用户是kibanaserver，但是我们并没有发现这个用户，这是因为用户有两种，<code class="highlighter-rouge">reserved: true</code>，<code class="highlighter-rouge">reserved: false</code>，这个是在<Elasticsearch directory="">/plugins/search-guard-7/sgconfig/sg_internal_users.yml中定义的</Elasticsearch></p>
  </li>
  <li>kibanaro：就是kibana read-only的缩写，这个账户可以看kibana界面，比如dashboard之类，但是无法管理索引，他有两个Backend Roles，<code class="highlighter-rouge">readall</code>和``，但是我们在配置文件（<Elasticsearch directory="">/plugins/search-guard-7/sgconfig/sg_roles.yml）中并没有找到他们，因为他们是内建的角色，可以参考[这个](https://docs.search-guard.com/latest/roles-permissions)</Elasticsearch></li>
  <li>logstash是类似的：只有一个组，这个是给logstash和beats的agent使用的，拥有logstash和beats的索引的所有权限</li>
  <li>readall：可以读所有索引，但是不能写</li>
  <li>snapshotrestore：可以创建和回复快照，主要是给自动化脚本用的</li>
</ul>

<h3 id="152-demo-2kibana用户权限">1.5.2. Demo 2：kibana用户权限</h3>

<ul>
  <li>我们创建一个用户，叫my-kibana，并且设置密码为my-kibana，不给任何权限</li>
  <li>登录kibana界面，会返回403错误</li>
  <li>修改my-kibana用户的角色，给他kibanauser的权限，就可以登录了，但是没办法看索引</li>
  <li>修改my-kibana用户的角色，给他readall的权限，就可以看discovery了</li>
</ul>

<h3 id="153-demo-3写权限">1.5.3. Demo 3：写权限</h3>

<ul>
  <li>我们配置一个fluent-bit的客户端，使用admin/admin账户来和ES通信</li>
  <li>我们把admin账户改成logstash账户，然后就会报错，没有权限</li>
  <li>我们把索引的名字改一下，从fluent-bit改成logstash，就没有问题了</li>
</ul>

<h3 id="154-demo-4创建自定义的角色">1.5.4. Demo 4：创建自定义的角色</h3>

<ul>
  <li>
    <p>我们为安全组创建一个权限，可以管理SG的审计日志，其他不允许看的权限，管理当然包括增删改查</p>
  </li>
  <li>
    <p>我们创建一个action group叫read-sg-audit，Type是Index，他的action group是SGS_INDICES_ALL，点击save</p>
  </li>
  <li>
    <p>创建一个Role，叫security-role，在index permissions选add，patterns手动输入sg7-*，action group选read-sg-audit，点击save</p>
  </li>
  <li>
    <p>创建用户security，为了看到效果，我们给他一个backend role叫kibanauser，点击save</p>
  </li>
  <li>
    <p>点击role mapping，选择security-role，Users选security，点击save</p>
  </li>
  <li>
    <p>使用security用户登录界面，这个用户只能看到和sg7-*有关的日志，其他的看不到</p>
  </li>
  <li>
    <p>使用http方式查询es的api</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-u</span> security:security <span class="s1">'https://localhost:9200/sg7-auditlog-2020.08.27/_doc/pRcQLnQB2xpX-EqCM2Nt?pretty'</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>删除这个doc</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-k</span> <span class="nt">-XDELETE</span> <span class="nt">-u</span> security:security <span class="s1">'https://localhost:9200/sg7-auditlog-2020.08.27/_doc/pRcQLnQB2xpX-EqCM2Nt?pretty'</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="16-收费模式">1.6. 收费模式</h3>

<p>SG有三个版本，社区版（community edition），专业版（enterprise edition），合规版（compliance edition），具体参考<a href="https://search-guard.com/licensing/">这个</a></p>

<ul>
  <li>社区版：免费使用，和收费版本的区别主要有三点
    <ul>
      <li>权限控制的粒度：免费版，只支持集群和索引级别的控制，而收费版可以精细到文档和字段级别，最高级的还可以支持匿名字段和固定某个字段不可删除</li>
      <li>认证和授权的方式：免费版，支持内部用户认证，http认证，PKI认证，代理认证。授权只有内部授权，和proxy header的授权，而收费版支持的很多很多，详见上面的地址</li>
      <li>配置方式：免费版，只可以使用命令行来配置，收费版可以使用图形界面来配置</li>
    </ul>
  </li>
  <li>专业版与合规版的区别主要是审计功能，专业版是没有审计功能的</li>
</ul>

<h3 id="17-sgadmin的使用">1.7. sgadmin的使用</h3>

<p>详细请参考<a href="https://docs.search-guard.com/latest/sgadmin-basic-usage">官方文档</a></p>

<h2 id="2-分词器系列">2. 分词器系列</h2>

<p>分词器是ES的特色之一，简单来说，分词器就是告诉ES怎样拆分一个句子中的词语，从而构建搜索的关键字的。比如，我们是小学生，那么分词器会把我们，小学生，作为搜索关键字来储存。一般来说，中文是需要中文的分词器的。而张三是小学生，就没办法识别，因为张三本身不是一个词，是一个名字，名字就无法被认为是一个词，而在实际生活中，明星的名字很有可能就是一个关键词，我们就需要手动为分词器添加关键字，也就是支持自定义关键字的分词器。比较常见的分词器有IK分词器，pinyin分词器。大家可以自己到<a href="https://github.com/medcl/">这里</a>去下载，使用教程也比较详细，我们不着重说了。</p>



      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
