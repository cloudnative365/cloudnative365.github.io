<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>日志系统概述 | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="日志系统概述" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L4_architect_3_logging_1_logging_overview.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L4_architect_3_logging_1_logging_overview.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"日志系统概述","url":"http://localhost:4000/keynotes_L4_architect_3_logging_1_logging_overview.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="学习目标">学习目标</h2>

<p>了解日志系统</p>

<p>熟悉常见的搜索引擎</p>

<p>学习云原生架构下的日志系统</p>

<p>Elastic Stack</p>

<p>Loki</p>

<h2 id="1-日志系统">1. 日志系统</h2>

<p>日志系统从我们学习Linux就一直伴随我们，我们做问题定位基本都是靠日志系统来实现的。实际上，我们常见的是系统日志，而真正的日志在广义上包括系统日志和应用日志。现在炒的火热的大数据分析，其实很多都是分析日志数据。一个银行系统，储存了这么多的用户信息，交易信息，也不过几百T的数据。而互联网公司，数据量都是EB，PB级别的。为什么这么多呢？因为主要都是日志，我们在界面上的每个操作，其实都已经被系统记录下来，以日志的方式储存起来，精确度越高，日志量越大。比如我们常见的推荐系统，你点击的每个页面都会被系统拿去做用户行为分析，甚至你在页面上停留的秒数都会被记录下来，所以，我们的日志量非常庞大。</p>

<p>我们常说的日志系统其实由下面几个部分组成：</p>

<ul>
  <li>agent：日志收集器，主要负责传输日志。不一定是特定的程序，也许是一个rsyslog的客户端。需要注意的是，我们使用rsyslog的时候，通常使用的是514端口，使用的协议是UDP。UDP是一个不可靠的传输协议，所以真正的生产上，我们不建议使用rsyslog直接传输日志，而是先写到本地，然后由agent收集之后，传送到服务器端。</li>
  <li>server：对agent传输过来的日志进行整理，或者对于用户的请求进行处理，他一般监听在http或者tcp的某个端口上。</li>
  <li>数据库：存储数据的软件，负责组织数据在硬盘，内存中的组织形式</li>
  <li>搜索引擎：通常是指我们查询的时候使用的一系列算法的组合。</li>
  <li>展示工具：负责展示我们的搜索结果</li>
</ul>

<h2 id="2-日志系统与搜索引擎">2. 日志系统与搜索引擎</h2>

<p>日志的格式基本都是以文本为主，所以搜索引擎首当其冲作为检索的工具是比较合适的，我们常见的搜索引擎有</p>

<ul>
  <li>lucene</li>
  <li>ElasticSearch</li>
  <li>Solr</li>
</ul>

<p>但是，搜索引擎是日志系统的一部分，也是比较核心的部分，但是，<strong>搜索引擎不等于日志系统</strong>。日志系统是包含了搜索引擎在内的非常多的组件组合而成的，只不过有些产品，以搜索引擎为核心，配套了很多的周边，形成了一套日志收集系统，比如我们下面要说的elasticsearch就是搜索引擎，他和周边很多产品才构成了我们的日志系统。</p>

<p>所以，我们的题目叫日志系统，而不是搜索引擎，和其他课程讲elasticsearch大数据开发相关知识不同，我们讲的是构建一套生产级别的日志系统，开发的事情还是交给程序员吧，我们运维的主要任务是提供稳定的环境。</p>

<h2 id="3-elastic-stack">3. Elastic Stack</h2>

<h3 id="31-elastic的产品线">3.1. Elastic的产品线</h3>

<p>目前为止，最新版本是7.9.0，一般来说，如果我们使用的是某一个版本，比如7.9.0，那么相应的其他的产品最好也升级，或者使用相同的版本，否则，日志中会报错。我们先来看一看es的产品线。</p>

<p>原址：https://www.elastic.co/cn/downloads/</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/image-20200825171346720.png" alt="image-20200825171346720" /></p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/image-20200825171452720.png" alt="image-20200825171452720" /></p>

<ul>
  <li>
    <p>ElasticSearch：主要产品</p>
  </li>
  <li>
    <p>Kibana：主要的展示平台，使用nodejs开发</p>
  </li>
  <li>Beats：相当于agent，里面包含了相当多的beats。下面会解释</li>
  <li>Logstash：可以当agent用，但是比agent增加了很多数据转换的功能</li>
  <li>APM：监控系统，收费功能</li>
  <li>Elastic企业搜索：SaaS产品，包含全套组件，官方的cloud</li>
  <li>Elastic Cloud：云托管，比如阿里云，腾讯云</li>
  <li>Elastic Cloud Enterprise：把SaaS产品下载到自己的机房</li>
  <li>Elastic Cloud on Kubernetes：在kubernetes上运行Cloud</li>
  <li>ES-Hadoop：从Hadoop中把数据导入到ES</li>
  <li>JDBC 客户端：es的java连接，jar包，收费功能</li>
  <li>ODBC客户端：主要给windows用的</li>
  <li>Elastic Cloud Control (ecctl)：ES的命令行工具，beta测试</li>
  <li>X-Pack：早期的（6.2之前的）一些工具集合，大部分收费功能</li>
  <li>Elastic代理：相当于一个反向代理，beta测试，收费功能</li>
</ul>

<p>其实早起的ES，只有ES，kibana和logstash产品，也就是我们通常说的ELK，而随着业务的需求，很多爱好者使用插件的方式，为ES添加了很多功能，而这些功能被ES慢慢吸收，用来增强自己的产品线，有的就干脆独立出来做成一款产品，可见ES还是非常受到开源社区的关注的。</p>

<h3 id="32-beats">3.2. beats</h3>

<p>beats作为ES的客户端，也就是我们常说的agent。ES把logstash定位为数据转换的工具，而对于不同的场景做了很多的beats，给logstash减减肥。我们只需要安装特定的beats就可以实现某一项工作。</p>

<p>原址：https://www.elastic.co/cn/downloads/beats</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/image-20200825172059895.png" alt="image-20200825172059895" /></p>

<ul>
  <li>filebeats：挖日志的</li>
  <li>Packetbeat：研究网络的情况，丢包率等等</li>
  <li>winlogbeat：挖window日志的</li>
  <li>metricbeat：挖掘监控指标的</li>
  <li>Heartbeat：看设备是否在线</li>
  <li>Auditbeat：挖审计日志的</li>
  <li>Functionbeat：监控AWS lamda的</li>
  <li>Journalbeat：挖掘journal日志的</li>
</ul>

<h3 id="33-定价">3.3. 定价</h3>

<p>大家可以自行参考自己关心的功能，我们这里主要说一下安全的功能。原址：https://www.elastic.co/cn/pricing/</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/image-20200825175543107.png" alt="image-20200825175543107" /></p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/image-20200825175713628.png" alt="image-20200825175713628" /></p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/image-20200825175742172.png" alt="image-20200825175742172" /></p>

<p>由于企业里面是需要用到认证功能的，所以我们需要安装其他的插件来解决这个问题，我们比较常用的就是searchguard，我们后面会有一章来介绍他。</p>

<h2 id="4-loki">4. Loki</h2>

<p>Loki是grafana lab的另外一款产品，他专注的是日志的检索功能，他可以和grafana很好的结合，做出非常漂亮的dashborad。这一款非常轻量的产品，功能，稳定和安全性肯定不能和elasticsearch来比，但是他叫做日志聚合系统（log aggregation），主打的是和grafana很好的结合，完善监控日志的功能。如果作为监控系统使用，我觉得Loki比ES更加适合。</p>

<h3 id="41-loki架构图">4.1. Loki架构图</h3>

<ul>
  <li>
    <p>物理架构</p>

    <p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/OIP.hlteEwpZJ72zcHXEzDmgRwHaDJ" alt="See the source image" /></p>

    <p>物理上架构非常简单，日志是通过Promtail组件来挖取的，然后promtail会把日志发送到loki的服务器，最后通过grafana进行展示</p>
  </li>
  <li>
    <p>逻辑架构</p>

    <p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/loki-arch.png" alt="See the source image" /></p>
  </li>
</ul>

<p>逻辑架构就比较复杂了，我们后面讲这个时候再一点点说</p>

<h3 id="42-展示工具">4.2. 展示工具</h3>

<p>既然是grafana的产品，不给他单独做一个dashboard就不太合适了，他的dashboard和ES差不多，同样是提供一个输入框，下面可以展示结果。</p>

<p><img src="/pages/keynotes/L4_architect/3_logging/pics/1_logging_overview/loki_grafana_filtering.png" alt="See the source image" /></p>

<h3 id="43-功能">4.3. 功能</h3>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
