<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>node_exporter | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="node_exporter" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L4_architect_2_monitoring_13_node_exporter.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L4_architect_2_monitoring_13_node_exporter.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"node_exporter","url":"http://localhost:4000/keynotes_L4_architect_2_monitoring_13_node_exporter.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="1-概述">1. 概述</h2>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/13_node_exporter/OIP.UqkmSzvXxcoGowCmvlBxmwHaE7" alt="See the source image" /></p>

<p>node_exporter是我们最常用的exporter之一，我们可以把他认为是一个agent，需要被安装在操作系统之上，然后才能采集到系统的数据。采集Linux类的exporter被称为node_exporter，如果我们使用sidecar的方式来运行的话，他就可以采集pod的信息。</p>

<p>我们在前面的指标采集一章中，已经使用node_exporter做了一个demo，他的采集的指标比zabbix多了好多。其实，这只是他的冰山一角，因为我们配置exporter的时候，使用的是默认启动的方式，他还有很多开关，需要添加参数才能生效。同时，他还可以指定那类指标不收集，以此来节省我们的资源消耗。</p>

<h2 id="2-详解node_exporter">2. 详解node_exporter</h2>

<p>node_exporter是prometheus官方提供的agent，项目被托管在prometheus的账号之下。我们也可以通过官方提供的链接<a href="https://prometheus.io/download/">下载</a>最新的版本。在官方的<a href="https://github.com/prometheus/node_exporter">github</a>里面已经提供了非常详细使用说明，我们这里带大家梳理一下</p>

<h3 id="21-默认启用的参数">2.1. 默认启用的参数</h3>

<p><a href="https://github.com/prometheus/node_exporter#enabled-by-default">官方地址</a>，这些参数就是我们前面做实验的时候默认收集的指标</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
      <th>OS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>arp</td>
      <td>Exposes ARP statistics from <code class="highlighter-rouge">/proc/net/arp</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>bcache</td>
      <td>Exposes bcache statistics from <code class="highlighter-rouge">/sys/fs/bcache/</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>bonding</td>
      <td>Exposes the number of configured and active slaves of Linux bonding interfaces.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>boottime</td>
      <td>Exposes system boot time derived from the <code class="highlighter-rouge">kern.boottime</code> sysctl.</td>
      <td>Darwin, Dragonfly, FreeBSD, NetBSD, OpenBSD, Solaris</td>
    </tr>
    <tr>
      <td>conntrack</td>
      <td>Shows conntrack statistics (does nothing if no <code class="highlighter-rouge">/proc/sys/net/netfilter/</code> present).</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>cpu</td>
      <td>Exposes CPU statistics</td>
      <td>Darwin, Dragonfly, FreeBSD, Linux, Solaris</td>
    </tr>
    <tr>
      <td>cpufreq</td>
      <td>Exposes CPU frequency statistics</td>
      <td>Linux, Solaris</td>
    </tr>
    <tr>
      <td>diskstats</td>
      <td>Exposes disk I/O statistics.</td>
      <td>Darwin, Linux, OpenBSD</td>
    </tr>
    <tr>
      <td>edac</td>
      <td>Exposes error detection and correction statistics.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>entropy</td>
      <td>Exposes available entropy.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>exec</td>
      <td>Exposes execution statistics.</td>
      <td>Dragonfly, FreeBSD</td>
    </tr>
    <tr>
      <td>filefd</td>
      <td>Exposes file descriptor statistics from <code class="highlighter-rouge">/proc/sys/fs/file-nr</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>filesystem</td>
      <td>Exposes filesystem statistics, such as disk space used.</td>
      <td>Darwin, Dragonfly, FreeBSD, Linux, OpenBSD</td>
    </tr>
    <tr>
      <td>hwmon</td>
      <td>Expose hardware monitoring and sensor data from <code class="highlighter-rouge">/sys/class/hwmon/</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>infiniband</td>
      <td>Exposes network statistics specific to InfiniBand and Intel OmniPath configurations.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>ipvs</td>
      <td>Exposes IPVS status from <code class="highlighter-rouge">/proc/net/ip_vs</code> and stats from <code class="highlighter-rouge">/proc/net/ip_vs_stats</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>loadavg</td>
      <td>Exposes load average.</td>
      <td>Darwin, Dragonfly, FreeBSD, Linux, NetBSD, OpenBSD, Solaris</td>
    </tr>
    <tr>
      <td>mdadm</td>
      <td>Exposes statistics about devices in <code class="highlighter-rouge">/proc/mdstat</code> (does nothing if no <code class="highlighter-rouge">/proc/mdstat</code> present).</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>meminfo</td>
      <td>Exposes memory statistics.</td>
      <td>Darwin, Dragonfly, FreeBSD, Linux, OpenBSD</td>
    </tr>
    <tr>
      <td>netclass</td>
      <td>Exposes network interface info from <code class="highlighter-rouge">/sys/class/net/</code></td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>netdev</td>
      <td>Exposes network interface statistics such as bytes transferred.</td>
      <td>Darwin, Dragonfly, FreeBSD, Linux, OpenBSD</td>
    </tr>
    <tr>
      <td>netstat</td>
      <td>Exposes network statistics from <code class="highlighter-rouge">/proc/net/netstat</code>. This is the same information as <code class="highlighter-rouge">netstat -s</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>nfs</td>
      <td>Exposes NFS client statistics from <code class="highlighter-rouge">/proc/net/rpc/nfs</code>. This is the same information as <code class="highlighter-rouge">nfsstat -c</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>nfsd</td>
      <td>Exposes NFS kernel server statistics from <code class="highlighter-rouge">/proc/net/rpc/nfsd</code>. This is the same information as <code class="highlighter-rouge">nfsstat -s</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>pressure</td>
      <td>Exposes pressure stall statistics from <code class="highlighter-rouge">/proc/pressure/</code>.</td>
      <td>Linux (kernel 4.20+ and/or <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/accounting/psi.txt">CONFIG_PSI</a>)</td>
    </tr>
    <tr>
      <td>rapl</td>
      <td>Exposes various statistics from <code class="highlighter-rouge">/sys/class/powercap</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>schedstat</td>
      <td>Exposes task scheduler statistics from <code class="highlighter-rouge">/proc/schedstat</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>sockstat</td>
      <td>Exposes various statistics from <code class="highlighter-rouge">/proc/net/sockstat</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>softnet</td>
      <td>Exposes statistics from <code class="highlighter-rouge">/proc/net/softnet_stat</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>stat</td>
      <td>Exposes various statistics from <code class="highlighter-rouge">/proc/stat</code>. This includes boot time, forks and interrupts.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>textfile</td>
      <td>Exposes statistics read from local disk. The <code class="highlighter-rouge">--collector.textfile.directory</code> flag must be set.</td>
      <td><em>any</em></td>
    </tr>
    <tr>
      <td>thermal_zone</td>
      <td>Exposes thermal zone &amp; cooling device statistics from <code class="highlighter-rouge">/sys/class/thermal</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>time</td>
      <td>Exposes the current system time.</td>
      <td><em>any</em></td>
    </tr>
    <tr>
      <td>timex</td>
      <td>Exposes selected adjtimex(2) system call stats.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>udp_queues</td>
      <td>Exposes UDP total lengths of the rx_queue and tx_queue from <code class="highlighter-rouge">/proc/net/udp</code> and <code class="highlighter-rouge">/proc/net/udp6</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>uname</td>
      <td>Exposes system information as provided by the uname system call.</td>
      <td>Darwin, FreeBSD, Linux, OpenBSD</td>
    </tr>
    <tr>
      <td>vmstat</td>
      <td>Exposes statistics from <code class="highlighter-rouge">/proc/vmstat</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>xfs</td>
      <td>Exposes XFS runtime statistics.</td>
      <td>Linux (kernel 4.4+)</td>
    </tr>
    <tr>
      <td>zfs</td>
      <td>Exposes <a href="http://open-zfs.org/">ZFS</a> performance statistics.</td>
      <td><a href="http://zfsonlinux.org/">Linux</a>, Solaris</td>
    </tr>
  </tbody>
</table>

<p>可以看到，每个指标都有他对应的操作系统，并不是每种系统都适用的。如果不想收集某个类型的指标，就使用<code class="highlighter-rouge">--no-collector.&lt;name&gt;</code>参数，比如</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./node_exporter <span class="nt">--no-collector</span>.time
</code></pre></div></div>

<h3 id="22-默认不启用的参数">2.2. 默认不启用的参数</h3>

<p>默认不启用的参数需要通过<code class="highlighter-rouge">--collector.&lt;name&gt;</code>参数来启用，官方提供的不启用的参数如下</p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Description</th>
      <th>OS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>buddyinfo</td>
      <td>Exposes statistics of memory fragments as reported by /proc/buddyinfo.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>devstat</td>
      <td>Exposes device statistics</td>
      <td>Dragonfly, FreeBSD</td>
    </tr>
    <tr>
      <td>drbd</td>
      <td>Exposes Distributed Replicated Block Device statistics (to version 8.4)</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>interrupts</td>
      <td>Exposes detailed interrupts statistics.</td>
      <td>Linux, OpenBSD</td>
    </tr>
    <tr>
      <td>ksmd</td>
      <td>Exposes kernel and system statistics from <code class="highlighter-rouge">/sys/kernel/mm/ksm</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>logind</td>
      <td>Exposes session counts from <a href="http://www.freedesktop.org/wiki/Software/systemd/logind/">logind</a>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>meminfo_numa</td>
      <td>Exposes memory statistics from <code class="highlighter-rouge">/proc/meminfo_numa</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>mountstats</td>
      <td>Exposes filesystem statistics from <code class="highlighter-rouge">/proc/self/mountstats</code>. Exposes detailed NFS client statistics.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>ntp</td>
      <td>Exposes local NTP daemon health to check <a href="https://github.com/prometheus/node_exporter/blob/master/docs/TIME.md">time</a></td>
      <td><em>any</em></td>
    </tr>
    <tr>
      <td>processes</td>
      <td>Exposes aggregate process statistics from <code class="highlighter-rouge">/proc</code>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>qdisc</td>
      <td>Exposes <a href="https://en.wikipedia.org/wiki/Network_scheduler#Linux_kernel">queuing discipline</a> statistics</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>runit</td>
      <td>Exposes service status from <a href="http://smarden.org/runit/">runit</a>.</td>
      <td><em>any</em></td>
    </tr>
    <tr>
      <td>supervisord</td>
      <td>Exposes service status from <a href="http://supervisord.org/">supervisord</a>.</td>
      <td><em>any</em></td>
    </tr>
    <tr>
      <td>systemd</td>
      <td>Exposes service and system status from <a href="http://www.freedesktop.org/wiki/Software/systemd/">systemd</a>.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>tcpstat</td>
      <td>Exposes TCP connection status information from <code class="highlighter-rouge">/proc/net/tcp</code> and <code class="highlighter-rouge">/proc/net/tcp6</code>. (Warning: the current version has potential performance issues in high load situations.)</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>wifi</td>
      <td>Exposes WiFi device and station statistics.</td>
      <td>Linux</td>
    </tr>
    <tr>
      <td>perf</td>
      <td>Exposes perf based metrics (Warning: Metrics are dependent on kernel configuration and settings).</td>
      <td>Linux</td>
    </tr>
  </tbody>
</table>

<p>如果大家使用的是Centos系，或者ubuntu系的，我们建议大家打开ntp，mountstats，systemd，ntp，tcpstat这几个选项</p>

<h3 id="23-文本收集器">2.3. 文本收集器</h3>

<p>使用<code class="highlighter-rouge">--collector.textfile.directory</code>选项可以把文本中的内容也用metrics的方式收集起来，但是用的不多，大家了解就好</p>

<h3 id="24-在prometheus中过滤collector">2.4. 在prometheus中过滤collector</h3>

<p>我们还可以在prometheus中过滤要采集的选项，在exporter的配置文件中使用下面的配置</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">params</span><span class="pi">:</span>
    <span class="s">collect[]</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">foo</span>
      <span class="pi">-</span> <span class="s">bar</span>
</code></pre></div></div>

<p>这个功能可以减少prometheus的压力，但是并不会减少node_exporter采集到的数据。有点鸡肋。。。既然不要这个，就不要采集了嘛。。。</p>

<h3 id="25-tls的配置">2.5. TLS的配置</h3>

<p>我们默认暴露的都是http的请求的，也没有验证，也就是明文传输，很容易存在安全隐患，如果需要对数据加密，我们就要使用参数<code class="highlighter-rouge">./node_exporter --web.config=web-config.yml</code>，这个文件的内容如下</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tls_server_config:
  <span class="c"># Certificate and key files for server to use to authenticate to client.</span>
  cert_file: &lt;filename&gt;
  key_file: &lt;filename&gt;

  <span class="c"># Server policy for client authentication. Maps to ClientAuth Policies.</span>
  <span class="c"># For more detail on clientAuth options: [ClientAuthType](https://golang.org/pkg/crypto/tls/#ClientAuthType)</span>
  <span class="o">[</span> client_auth_type: &lt;string&gt; | default <span class="o">=</span> <span class="s2">"NoClientCert"</span> <span class="o">]</span>

  <span class="c"># CA certificate for client certificate authentication to the server.</span>
  <span class="o">[</span> client_ca_file: &lt;filename&gt; <span class="o">]</span>

  <span class="c"># Minimum TLS version that is acceptable.</span>
  <span class="o">[</span> min_version: &lt;string&gt; | default <span class="o">=</span> <span class="s2">"TLS12"</span> <span class="o">]</span>

  <span class="c"># Maximum TLS version that is acceptable.</span>
  <span class="o">[</span> max_version: &lt;string&gt; | default <span class="o">=</span> <span class="s2">"TLS13"</span> <span class="o">]</span>

  <span class="c"># List of supported cipher suites for TLS versions up to TLS 1.2. If empty,</span>
  <span class="c"># Go default cipher suites are used. Available cipher suites are documented</span>
  <span class="c"># in the go documentation:</span>
  <span class="c"># https://golang.org/pkg/crypto/tls/#pkg-constants</span>
  <span class="o">[</span> cipher_suites:
    <span class="o">[</span> - &lt;string&gt; <span class="o">]</span> <span class="o">]</span>

  <span class="c"># prefer_server_cipher_suites controls whether the server selects the</span>
  <span class="c"># client's most preferred ciphersuite, or the server's most preferred</span>
  <span class="c"># ciphersuite. If true then the server's preference, as expressed in</span>
  <span class="c"># the order of elements in cipher_suites, is used.</span>
  <span class="o">[</span> prefer_server_cipher_suites: &lt;bool&gt; | default <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span>

  <span class="c"># Elliptic curves that will be used in an ECDHE handshake, in preference</span>
  <span class="c"># order. Available curves are documented in the go documentation:</span>
  <span class="c"># https://golang.org/pkg/crypto/tls/#CurveID</span>
  <span class="o">[</span> curve_preferences:
    <span class="o">[</span> - &lt;string&gt; <span class="o">]</span> <span class="o">]</span>

http_server_config:
  <span class="c"># Enable HTTP/2 support. Note that HTTP/2 is only supported with TLS.</span>
  <span class="c"># This can not be changed on the fly.</span>
  <span class="o">[</span> http2: &lt;bool&gt; | default <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span>

<span class="c"># Usernames and hashed passwords that have full access to the web</span>
<span class="c"># server via basic authentication. If empty, no basic authentication is</span>
<span class="c"># required. Passwords are hashed with bcrypt.</span>
basic_auth_users:
  <span class="o">[</span> &lt;string&gt;: &lt;secret&gt; ... <span class="o">]</span>
</code></pre></div></div>

<p>这里面的密码是使用hash来加密的，我们常用的工具是htpasswd，比如，我们要加密密码Passw0rd</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>htpasswd <span class="nt">-nBC</span> 10 <span class="s2">""</span> | tr <span class="nt">-d</span> <span class="s1">':\n'</span>
New password: 
Re-type new password: 
<span class="nv">$2y$10$6oDcZssS</span>/R6yPy8ixVx7ue8LiPX7CHpNtXxdVGlYkNgzW3CT48TfC%
</code></pre></div></div>

<p>使用不交互的方式，生成文件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>htpasswd <span class="nt">-bc</span> /application/prometheus/conf/htpasswd admin Passw0rd
</code></pre></div></div>

<p>在原有文件中添加一个用户</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>htpasswd <span class="nt">-b</span> /application/prometheus/conf/htpasswd admin Passw0rd
</code></pre></div></div>

<p>不更新密码文件，只在屏幕上输出用户名和经过加密后的密码</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>htpasswd <span class="nt">-nb</span> admin Passw0rd
</code></pre></div></div>

<h3 id="26-systemd例子">2.6. systemd例子</h3>

<p>为了便于管理，我们使用systemd来管理这个服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;</span> /etc/systemd/system/node_exporter.service <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
[Unit]
Description=node_exporter
Documentation=https://prometheus.io/
After=network.target
[Service]
Type=simple
User=prometheus
ExecStart=/usr/local/bin/node_exporter \
          --web.config=web-config.yml \
          --collector.ntp \
          --collector.mountstats \
          --collector.systemd \
          --collector.ntp \
          --collector.tcpstat
ExecReload=/bin/kill -HUP </span><span class="nv">$MAINPID</span><span class="sh">
TimeoutStopSec=20s
Restart=always
[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>



      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
