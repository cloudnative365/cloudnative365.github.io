<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>伸缩etcd集群 | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="伸缩etcd集群" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L3_senior_1_etcd_4_scale_etcd.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L3_senior_1_etcd_4_scale_etcd.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"伸缩etcd集群","url":"http://localhost:4000/keynotes_L3_senior_1_etcd_4_scale_etcd.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="课程目标">课程目标</h2>

<ul>
  <li>向etcd集群中添加节点</li>
  <li>从etcd集群中删除节点</li>
  <li>etcd集群的备份与恢复</li>
  <li>etcd集群的升级</li>
</ul>

<h2 id="1-环境">1. 环境</h2>

<table>
  <thead>
    <tr>
      <th>IP</th>
      <th>HOST</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>10.0.11.36</td>
      <td>infra0</td>
    </tr>
    <tr>
      <td>10.0.12.21</td>
      <td>infra1</td>
    </tr>
    <tr>
      <td>10.0.13.126</td>
      <td>infra2</td>
    </tr>
    <tr>
      <td>10.0.12.157</td>
      <td>infra3</td>
    </tr>
    <tr>
      <td>10.0.13.118</td>
      <td>infra4</td>
    </tr>
  </tbody>
</table>

<p>且infra0，infra1，infra2是创建好的etcd集群，方法请看<a href="https://cloudnative365.github.io/keynotes_L3_senior_1_etcd_2_install_etcd.html">这里</a></p>

<h2 id="2-向etcd集群中添加节点">2. 向etcd集群中添加节点</h2>

<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#scaling-up-etcd-clusters">官方文档</a>中不建议我们向生产系统中添加节点，因为添加etcd节点会损失集群的性能，增加节点并不会增加集群的性能或者是容量。一般来说不建议对etcd集群扩/缩容。更不要配置任何的etcd集群自动扩展策略。我们建议在生产系统中部署五个member的etcd集群。过程参考<a href="https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/runtime-configuration.md#remove-a-member">github</a>。</p>

<p>当然，如果有特殊需求，我们也可以部署7个节点，比如两地三中心的架构，三个DC中分别部署2/2/3个etcd集群。</p>

<h3 id="21-添加一个正常工作的etcd节点">2.1. 添加一个正常工作的etcd节点</h3>

<p>一般来说，添加节点有两个步骤：</p>

<ul>
  <li>我们可以通过 <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/v2/members_api.md">HTTP members API</a>， <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/dev-guide/api_reference_v3.md#service-cluster-etcdserveretcdserverpbrpcproto">gRPC members API</a>,或者是 <code class="highlighter-rouge">etcdctl member add</code> 命令。当然我们肯定是需要使用etcdctl命令的</li>
  <li>使用新的集群配置启动新的节点</li>
  <li>同步后，使用新的配置重新启动原有节点</li>
</ul>

<p><strong>注意1</strong>：如果原来的etcd使用的是ssl证书在签署的时候，指定了hosts的地址的证书是不能够使用的，比如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl certinfo <span class="nt">-csr</span> server.csr
<span class="nb">.</span>
<span class="nb">.</span>
  <span class="s2">"IPAddresses"</span>: <span class="o">[</span>
    <span class="s2">"127.0.0.1"</span>,
    <span class="s2">"10.0.11.36"</span>,
    <span class="s2">"10.0.12.21"</span>,
    <span class="s2">"10.0.13.126"</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<p>这样的证书在添加了新的member之后是无法正常通信的，需要重新签署证书，把新的节点加入到证书中。</p>

<p><strong>注意2</strong>：由于签署的证书只用于数据传输，不用于数据加密，所以即使更换CA，重新签署证书，也是没有问题的。但是，如果我们首次启动etcd集群的时候使用的是非加密方式，后面改成SSL方式启动etcd集群的时候就会报错</p>

<p><strong>注意3</strong>：json文件无法使用<code class="highlighter-rouge">hosts: [""] </code>这种方式来通配所有地址（理论上可以行，实际操作上报错）</p>

<p><strong>注意4</strong>：json文件中可以使用域名来通配一类host，理论上可行，但是没有测试</p>

<h4 id="211-环境准备">2.1.1. 环境准备</h4>

<p>请参考<a href="https://cloudnative365.github.io/keynotes_L3_senior_1_etcd_2_install_etcd.html#31-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83">环境准备</a>和<a href="https://cloudnative365.github.io/keynotes_L3_senior_1_etcd_2_install_etcd.html#32-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%8C%85%E5%AE%89%E8%A3%85etcd">下载和解压</a></p>

<h4 id="212-添加节点">2.1.2. 添加节点</h4>

<ul>
  <li>
    <p>检查节点健康状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
  
466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>在任意一个etcd节点上执行</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member add infra3 <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> <span class="nt">--peer-urls</span><span class="o">=</span>https://10.0.12.157:2380
  
Member 6a5e9d82c1c1c471 added to cluster f36e4227f36fdc03
  
<span class="nv">ETCD_NAME</span><span class="o">=</span><span class="s2">"infra3"</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"infra2=https://10.0.13.126:2380,infra3=https://10.0.12.157:2380,infra1=https://10.0.12.21:2380,infra0=https://10.0.11.36:2380"</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://10.0.12.157:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"existing"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>再查看集群状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
  
466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, unstarted, , https://10.0.12.157:2380, , <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>在新节点创建配置文件/etc/etcd/etcd.conf</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>infra3
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.12.157
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">infra0</span><span class="o">=</span>https://10.0.11.36:2380,infra1<span class="o">=</span>https://10.0.12.21:2380,infra2<span class="o">=</span>https://10.0.13.126:2380,infra3<span class="o">=</span>https://10.0.12.157:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>existing
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改systemd文件/lib/systemd/system/etcd.service</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target
  
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/data/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2"> /opt/etcd/etcd </span><span class="se">\</span><span class="s2">
          --data-dir </span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --name </span><span class="k">${</span><span class="nv">HOST_NAME</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-advertise-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --listen-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --advertise-client-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-client-urls https://127.0.0.1:2379,https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-metrics-urls=http://127.0.0.1:2381 </span><span class="se">\</span><span class="s2">
          --initial-cluster </span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-state </span><span class="k">${</span><span class="nv">CLUSTER_STATE</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-token </span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --client-cert-auth </span><span class="se">\</span><span class="s2">
          --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --cert-file=/etc/kubernetes/pki/etcd/server.pem </span><span class="se">\</span><span class="s2">
          --key-file=/etc/kubernetes/pki/etcd/server-key.pem </span><span class="se">\</span><span class="s2">
          --peer-client-cert-auth </span><span class="se">\</span><span class="s2">
          --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --peer-cert-file=/etc/kubernetes/pki/etcd/members.pem </span><span class="se">\</span><span class="s2">
          --peer-key-file=/etc/kubernetes/pki/etcd/members-key.pem"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536
  
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div>    </div>
  </li>
  <li>
    <p>通过scp方式把etcd的pki同步到新机器上并修改权限</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod 400 /etc/kubernetes/pki/etcd/<span class="k">*</span>
chown <span class="nt">-R</span> etcd:adm /etc/kubernetes/pki/etcd/
</code></pre></div>    </div>
  </li>
  <li>
    <p>在新节点上启动etcd</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start etcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>如果报错，就吧数据文件<code class="highlighter-rouge">/data/etcd/member</code>删除再重启</p>
  </li>
  <li>
    <p>这时候再list member</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
  
466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>注意</strong>：修改每个节点上的/etc/etcd/etcd.conf都需要修改为对应的配置</p>
  </li>
</ul>

<h4 id="213-添加一个learner-etcd节点">2.1.3. 添加一个learner etcd节点</h4>

<p>从etcd3.4版本之后，etcd知识把节点添加为learner节点（不会参与投票的节点）。这样做是为了让添加新节点更加的安全，较少添加节点过程中集群的宕机时间，我们建议在节点在完全同步数据之前作为learner节点。所以我们增加节点的步骤变成了下面几个</p>

<ul>
  <li>我们可以通过 <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/v2/members_api.md">HTTP members API</a>， <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/dev-guide/api_reference_v3.md#service-cluster-etcdserveretcdserverpbrpcproto">gRPC members API</a>,或者是 <code class="highlighter-rouge">etcdctl member add --learner</code> 命令.</li>
  <li>使用新的集群配置启动新的节点</li>
  <li>使用新的配置重新启动原有节点</li>
  <li>使用 <a href="https://github.com/etcd-io/etcd/blob/master/Documentation/dev-guide/api_reference_v3.md#service-cluster-etcdserveretcdserverpbrpcproto">gRPC members API</a>,或者是 <code class="highlighter-rouge">etcdctl member promote</code>命令来让learner节点成为有投票权的节点。这个时候etcd集群会检查一下promote的请求来确认这个操作是安全的。他会去确认learner节点确实已经同步了leader数据的节点，然后才让这个节点拥有投票权。</li>
</ul>

<h4 id="214-添加learner-etcd节点具体操作如下">2.1.4. 添加learner etcd节点具体操作如下</h4>

<ul>
  <li>
    <p>检查节点健康状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
  
466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>在任意一个etcd节点上执行</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member add infra4 <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> <span class="nt">--peer-urls</span><span class="o">=</span>https://10.0.13.118:2380 <span class="nt">--learner</span>
Member d11c0954aee6f056 added to cluster f36e4227f36fdc03
  
<span class="nv">ETCD_NAME</span><span class="o">=</span><span class="s2">"infra4"</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"infra2=https://10.0.13.126:2380,infra3=https://10.0.12.157:2380,infra1=https://10.0.12.21:2380,infra4=https://10.0.13.118:2380,infra0=https://10.0.11.36:2380"</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://10.0.13.118:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"existing"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>再查看集群状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
  
249badc16d370eb0, unstarted, , https://10.0.13.118:2380, , <span class="nb">true
</span>466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>在新节点创建配置文件/etc/etcd/etcd.conf</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>infra4
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.13.118
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">infra0</span><span class="o">=</span>https://10.0.11.36:2380,infra1<span class="o">=</span>https://10.0.12.21:2380,infra2<span class="o">=</span>https://10.0.13.126:2380,infra3<span class="o">=</span>https://10.0.12.157:2380,infra4<span class="o">=</span>https://10.0.13.118:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>existing
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改systemd文件/lib/systemd/system/etcd.service</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target
  
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/data/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2"> /opt/etcd/etcd </span><span class="se">\</span><span class="s2">
          --data-dir </span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --name </span><span class="k">${</span><span class="nv">HOST_NAME</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-advertise-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --listen-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --advertise-client-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-client-urls https://127.0.0.1:2379,https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-metrics-urls=http://127.0.0.1:2381 </span><span class="se">\</span><span class="s2">
          --initial-cluster </span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-state </span><span class="k">${</span><span class="nv">CLUSTER_STATE</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-token </span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --client-cert-auth </span><span class="se">\</span><span class="s2">
          --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --cert-file=/etc/kubernetes/pki/etcd/server.pem </span><span class="se">\</span><span class="s2">
          --key-file=/etc/kubernetes/pki/etcd/server-key.pem </span><span class="se">\</span><span class="s2">
          --peer-client-cert-auth </span><span class="se">\</span><span class="s2">
          --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --peer-cert-file=/etc/kubernetes/pki/etcd/members.pem </span><span class="se">\</span><span class="s2">
          --peer-key-file=/etc/kubernetes/pki/etcd/members-key.pem"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536
  
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div>    </div>
  </li>
  <li>
    <p>通过scp方式把etcd的pki同步到新机器上并修改权限</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>chmod 400 /etc/kubernetes/pki/etcd/<span class="k">*</span>
<span class="nv">$ </span>chown <span class="nt">-R</span> etcd:adm /etc/kubernetes/pki/etcd/
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动etcd</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl start etcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>再查看集群状态，发现infra4的learner是true</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
12d20db544264be2, started, infra4, https://10.0.13.118:2380, https://10.0.13.118:2379, <span class="nb">true
</span>466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看集群状态，集群状态的显示结果为<code class="highlighter-rouge">The items in the lists are endpoint, ID, version, db size, is leader, is learner, raft term, raft index, raft applied index, errors.</code></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl endpoint status <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> <span class="nt">--endpoints</span><span class="o">=</span>https://127.0.0.1:2379 <span class="nt">--cluster</span>
https://10.0.13.118:2379, 12d20db544264be2, 3.4.9, 16 kB, <span class="nb">false</span>, <span class="nb">true</span>, 4232, 26, 26,
https://10.0.13.126:2379, 466035bfe5ac7a64, 3.4.9, 20 kB, <span class="nb">false</span>, <span class="nb">false</span>, 4232, 26, 26,
https://10.0.12.157:2379, 6a5e9d82c1c1c471, 3.4.9, 20 kB, <span class="nb">false</span>, <span class="nb">false</span>, 4232, 26, 26,
https://10.0.12.21:2379, 784e0050552d81cd, 3.4.9, 20 kB, <span class="nb">false</span>, <span class="nb">false</span>, 4232, 26, 26,
https://10.0.11.36:2379, f7d6895384ae86d2, 3.4.9, 20 kB, <span class="nb">true</span>, <span class="nb">false</span>, 4232, 26, 26,
</code></pre></div>    </div>
  </li>
  <li>
    <p>当信息同步之后，我们就可以开始promote了</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member promote 12d20db544264be2 <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span>
Member 12d20db544264be2 promoted <span class="k">in </span>cluster f36e4227f36fdc03
</code></pre></div>    </div>
  </li>
  <li>
    <p>再查看集群状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
12d20db544264be2, started, infra4, https://10.0.13.118:2380, https://10.0.13.118:2379, <span class="nb">false
</span>466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>注意</strong>：修改每个节点上的/etc/etcd/etcd.conf都需要修改为对应的配置</p>
  </li>
</ul>

<h3 id="22-如果添加节点出现问题">2.2. 如果添加节点出现问题</h3>

<p>我们这里举例是同步出现问题，比如：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcd <span class="nt">--name</span> infra3 <span class="se">\</span>
  <span class="nt">--initial-cluster</span> <span class="nv">infra0</span><span class="o">=</span>http://10.0.1.10:2380,infra1<span class="o">=</span>http://10.0.1.11:2380,infra2<span class="o">=</span>http://10.0.1.12:2380 <span class="se">\</span>
  <span class="nt">--initial-cluster-state</span> existing
etcdserver: assign ids error: the member count is unequal
<span class="nb">exit </span>1
</code></pre></div></div>

<p>我们需要清空数据文件，再更换一下节点的信息（节点名称和IP）</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcd <span class="nt">--name</span> infra4 <span class="se">\</span>
  <span class="nt">--initial-cluster</span> <span class="nv">infra0</span><span class="o">=</span>http://10.0.1.10:2380,infra1<span class="o">=</span>http://10.0.1.11:2380,infra2<span class="o">=</span>http://10.0.1.12:2380,infra4<span class="o">=</span>http://10.0.1.14:2380 <span class="se">\</span>
  <span class="nt">--initial-cluster-state</span> existing
etcdserver: assign ids error: unmatched member <span class="k">while </span>checking PeerURLs
<span class="nb">exit </span>1
</code></pre></div></div>

<h3 id="23-如果添加learner节点出现问题">2.3. 如果添加learner节点出现问题</h3>

<ul>
  <li>集群中多于1个learner会报错</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member add infra4 <span class="nt">--peer-urls</span><span class="o">=</span>http://10.0.1.14:2380 <span class="nt">--learner</span>
Error: etcdserver: too many learner members <span class="k">in </span>cluster
</code></pre></div></div>

<ul>
  <li>数据不同步的情况下会报错</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member promote 9bf1b35fc7761a23
Error: etcdserver: can only promote a learner member which is <span class="k">in </span>sync with leader
</code></pre></div></div>

<ul>
  <li>提升一个不是learner的节点会报错</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member promote 9bf1b35fc7761a23
Error: etcdserver: can only promote a learner member
</code></pre></div></div>

<ul>
  <li>提升一个不存在的learner节点会报错</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member promote 12345abcde
Error: etcdserver: member not found
</code></pre></div></div>

<h2 id="3-移除节点">3. 移除节点</h2>

<ul>
  <li>
    <p>查看集群状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
12d20db544264be2, started, infra4, https://10.0.13.118:2380, https://10.0.13.118:2379, <span class="nb">false
</span>466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>从集群中删除节点infra4</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member remove 12d20db544264be2 <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span>
Member 12d20db544264be2 removed from cluster f36e4227f36fdc03
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>etcdctl member <span class="nt">--cacert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/ca.pem"</span> <span class="nt">--cert</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members.pem"</span> <span class="nt">--key</span><span class="o">=</span><span class="s2">"/etc/kubernetes/pki/etcd/members-key.pem"</span> list
466035bfe5ac7a64, started, infra2, https://10.0.13.126:2380, https://10.0.13.126:2379, <span class="nb">false
</span>6a5e9d82c1c1c471, started, infra3, https://10.0.12.157:2380, https://10.0.12.157:2379, <span class="nb">false
</span>784e0050552d81cd, started, infra1, https://10.0.12.21:2380, https://10.0.12.21:2379, <span class="nb">false
</span>f7d6895384ae86d2, started, infra0, https://10.0.11.36:2380, https://10.0.11.36:2379, <span class="nb">false</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>注意</strong>：修改每个节点上的/etc/etcd/etcd.conf都需要修改为对应的配置</p>
  </li>
</ul>



      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
