<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>安装etcd | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="安装etcd" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L3_senior_1_etcd_2_install_etcd.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L3_senior_1_etcd_2_install_etcd.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"安装etcd","url":"http://localhost:4000/keynotes_L3_senior_1_etcd_2_install_etcd.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="课程目标">课程目标</h2>

<ul>
  <li>安装单机版etcd</li>
  <li>安装etcd集群</li>
  <li>配置安全的etcd（配置SSL证书）</li>
</ul>

<h2 id="1-环境">1. 环境</h2>

<h3 id="11-软件版本">1.1. 软件版本</h3>

<table>
  <thead>
    <tr>
      <th>环境</th>
      <th>版本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>操作系统</td>
      <td>linux大部分发行版都可以（ubuntu/rhel/centos）</td>
    </tr>
    <tr>
      <td>内核版本</td>
      <td>3.10和4.15</td>
    </tr>
    <tr>
      <td>etcd</td>
      <td>v3.4.9</td>
    </tr>
    <tr>
      <td>golang</td>
      <td>1.14.3</td>
    </tr>
  </tbody>
</table>

<h3 id="12-硬件规划">1.2. 硬件规划</h3>

<p>关于机器选项可以参考<a href="https://etcd.io/docs/v3.4.0/op-guide/hardware/#example-hardware-configurations">这个</a></p>

<p>Here are a few example hardware setups on AWS and GCE environments. As mentioned before, but must be stressed regardless, administrators should test an etcd deployment with a simulated workload before putting it into production.</p>

<p>Note that these configurations assume these machines are totally dedicated to etcd. Running other applications along with etcd on these machines may cause resource contentions and lead to cluster instability.</p>

<h3 id="small-cluster">Small cluster</h3>

<p>A small cluster serves fewer than 100 clients, fewer than 200 of requests per second, and stores no more than 100MB of data.</p>

<p>Example application workload: A 50-node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.large</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">3600</td>
      <td style="text-align: left">56.25</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-2 + 50GB PD SSD</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">7.5</td>
      <td style="text-align: left">1500</td>
      <td style="text-align: left">25</td>
    </tr>
  </tbody>
</table>

<h3 id="medium-cluster">Medium cluster</h3>

<p>A medium cluster serves fewer than 500 clients, fewer than 1,000 of requests per second, and stores no more than 500MB of data.</p>

<p>Example application workload: A 250-node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.xlarge</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">6000</td>
      <td style="text-align: left">93.75</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-4 + 150GB PD SSD</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">15</td>
      <td style="text-align: left">4500</td>
      <td style="text-align: left">75</td>
    </tr>
  </tbody>
</table>

<h3 id="large-cluster">Large cluster</h3>

<p>A large cluster serves fewer than 1,500 clients, fewer than 10,000 of requests per second, and stores no more than 1GB of data.</p>

<p>Example application workload: A 1,000-node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.2xlarge</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">32</td>
      <td style="text-align: left">8000</td>
      <td style="text-align: left">125</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-8 + 250GB PD SSD</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">30</td>
      <td style="text-align: left">7500</td>
      <td style="text-align: left">125</td>
    </tr>
  </tbody>
</table>

<h3 id="xlarge-cluster">xLarge cluster</h3>

<p>An xLarge cluster serves more than 1,500 clients, more than 10,000 of requests per second, and stores more than 1GB data.</p>

<p>Example application workload: A 3,000 node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.4xlarge</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">64</td>
      <td style="text-align: left">16,000</td>
      <td style="text-align: left">250</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-16 + 500GB PD SSD</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">60</td>
      <td style="text-align: left">15,000</td>
      <td style="text-align: left">250</td>
    </tr>
  </tbody>
</table>

<h2 id="2-安装单机版etcd">2. 安装单机版etcd</h2>

<h3 id="21-二进制包安装etcd">2.1. 二进制包安装etcd</h3>

<ul>
  <li>
    <p>下载和解压</p>

    <p><a href="https://github.com/etcd-io/etcd/releases/">这里</a>有下载的向导，也可以点这里直接下载<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz">v3.4.9</a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#设置要下载的版本</span>
<span class="nv">ETCD_VER</span><span class="o">=</span>v3.4.9
<span class="nv">INSTALL_DIR</span><span class="o">=</span>/opt
  
<span class="c"># 也可以从google下载，鉴于国内无法访问，就注释掉了</span>
<span class="c"># GOOGLE_URL=https://storage.googleapis.com/etcd</span>
<span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/etcd-io/etcd/releases/download
<span class="nv">DOWNLOAD_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">GITHUB_URL</span><span class="k">}</span>
  
<span class="c"># 清理原来下载过的</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="o">&amp;&amp;</span> mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd
  
<span class="c"># 下载</span>
curl <span class="nt">-L</span> <span class="k">${</span><span class="nv">DOWNLOAD_URL</span><span class="k">}</span>/<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-o</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar </span>xzvf <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-C</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="nt">--strip-components</span><span class="o">=</span>1
<span class="c"># 删除压缩包</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
  
<span class="c"># 测试</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcd <span class="nt">--version</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcdctl version
  
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动etcd</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./etcd
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="22-编译安装etcd">2.2. 编译安装etcd</h3>

<ul>
  <li>
    <p>官方文档在<a href="https://etcd.io/docs/v3.4.0/dl-build/">这里</a></p>
  </li>
  <li>
    <p>注意：编译安装的话需要安装1.14版本及以上的golang环境，下载golang的二进制包，配置GOROOT和GOPATH</p>
  </li>
  <li>
    <p>注意：官网要求golang版本是1.13以上（也就是1.14版本），目前的镜像只有RHEL8.2和AMAZON linux2的yum源中的golang是1.13版本，换句话说，截止2020年5月27日，如果想编译安装etcd，必须自己手动配置golang环境</p>
  </li>
  <li>
    <p>注意：目前版本上使用编译后的etcd创建集群的时候会出现错误，目前测试在AWS的linux2上会出现这个问题，所以只有二进制方式安装最保险</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>panic: runtime error: invalid memory address or nil pointer dereference
</code></pre></div>    </div>
  </li>
  <li>
    <p>下载golang</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 国内无法访问google，请使用下面的链接下载二进制包</span>
wget https://studygolang.com/dl/golang/go1.14.3.linux-amd64.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar </span>xf go1.14.3.linux-amd64.tar.gz
<span class="c"># 验证</span>
./go/bin/go version
go version go1.14.3 linux/amd64
</code></pre></div>    </div>
  </li>
  <li>
    <p>配置go环境</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/profile.d/golong.sh
export GOROOT=/opt/go
export PATH=</span><span class="nv">$PATH</span><span class="sh">:/opt/go/bin
</span><span class="no">EOF
  
</span><span class="nb">source</span> /etc/profile
</code></pre></div>    </div>
  </li>
  <li>
    <p>编译</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/etcd-io/etcd.git
<span class="nv">$ </span><span class="nb">cd </span>etcd
<span class="nv">$ </span>go env <span class="nt">-w</span> <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,direct
<span class="nv">$ </span>go mod vendor
<span class="nv">$ </span>./build
</code></pre></div>    </div>
  </li>
  <li>
    <p>验证</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在bin目录下面会多出两个可执行文件</span>
<span class="nb">ls </span>bin/
etcd  etcdctl
  
<span class="c"># 查看版本</span>
<span class="nv">$ </span>./bin/etcd <span class="nt">--version</span>
etcd Version: 3.5.0-pre
Git SHA: 9b6c3e337
Go Version: go1.14.3
Go OS/Arch: linux/amd64
  
<span class="nv">$ </span>./bin/etcdctl version
etcdctl version: 3.5.0-pre
API version: 3.5
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="3-安装etcd集群">3. 安装etcd集群</h2>

<p>如果是简单的demo，我们可以参考<a href="https://etcd.io/docs/v3.4.0/demo/">官方文档</a>。这里介绍的是在生产环境上搭建etcd集群。</p>

<h3 id="31-准备环境">3.1. 准备环境</h3>

<ul>
  <li>
    <p>配置时间服务，ntpd和chrony都可以</p>
  </li>
  <li>
    <p>为etcd创建独立的文件系统，在公有云环境中，系统基本都是镜像启动的，实例被干掉之后容易丢数据，而且速度不如外挂存储卷，且稳定性好。</p>

    <p>注意：不管我们的数据放在哪里，都有丢失的危险，一定要记得备份！etcd再轻量也是数据库，数据丢了，什么都没了</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lvcreate <span class="nt">-n</span> lv_etcd <span class="nt">-L</span> 10G vg_system
<span class="nv">$ </span>mkfs.xfs /dev/mapper/vg_system-lv_etcd
<span class="nv">$ </span>mkdir <span class="nt">-p</span> /data/etcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>权限控制</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建etcd用户，只用来跑程序</span>
<span class="nv">$ </span>useradd etcd
<span class="c"># 修改etcd的主要组为adm，便于同属于adm组的管理员查看，并且指定不可以登录</span>
<span class="nv">$ </span>usermod <span class="nt">-g</span> adm <span class="nt">-s</span> nologin etcd
<span class="c"># 修改数据的权限，etcd用户拥有所有的权限</span>
<span class="c"># etcd所在的组adm拥有读和执行的权限，方便管理员查看或者备份，也可以给他只读权限</span>
<span class="c"># 其他人员没有权限</span>
<span class="c"># root拥有所有权限</span>
<span class="nv">$ </span>chmod 740 /data/etcd
<span class="nv">$ </span>chown etcd:adm /data/etcd
<span class="nv">$ </span>mkdir /etc/etcd
<span class="nv">$ </span>chmod 740 /data/etcd
<span class="nv">$ </span>chown etcd:adm /etc/etcd
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="32-二进制包安装etcd">3.2. 二进制包安装etcd</h3>

<ul>
  <li>
    <p>下载和解压</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#设置要下载的版本</span>
<span class="nv">ETCD_VER</span><span class="o">=</span>v3.4.9
<span class="nv">INSTALL_DIR</span><span class="o">=</span>/opt
  
<span class="c"># 也可以从google下载，鉴于国内无法访问，就注释掉了</span>
<span class="c"># GOOGLE_URL=https://storage.googleapis.com/etcd</span>
<span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/etcd-io/etcd/releases/download
<span class="nv">DOWNLOAD_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">GITHUB_URL</span><span class="k">}</span>
  
<span class="c"># 清理原来下载过的</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="o">&amp;&amp;</span> mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd
  
<span class="c"># 下载</span>
curl <span class="nt">-L</span> <span class="k">${</span><span class="nv">DOWNLOAD_URL</span><span class="k">}</span>/<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-o</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar </span>xzvf <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-C</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="nt">--strip-components</span><span class="o">=</span>1
<span class="c"># 删除压缩包</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
  
<span class="c"># 测试</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcd <span class="nt">--version</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcdctl version
</code></pre></div>    </div>
  </li>
  <li>
    <p>配置etcd的路径</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/profile.d/etcd.sh
export PATH=</span><span class="nv">$PATH</span><span class="sh">:/opt/etcd
</span><span class="no">EOF
  
</span><span class="nb">source</span> /etc/profile
</code></pre></div>    </div>
  </li>
  <li>
    <p>生成一个长一点的token保证安全</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo </span>k8s-cluster|md5sum
ea8cfe2bfe85b7e6c66fe190f9225838  -
</code></pre></div>    </div>
  </li>
  <li>
    <p>配置文件/etc/etcd/etcd.conf</p>

    <p>master1</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master1
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.204
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>http://10.0.1.204:2380,master2<span class="o">=</span>http://10.0.1.67:2380,master3<span class="o">=</span>http://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master2</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master2
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.67
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>http://10.0.1.204:2380,master2<span class="o">=</span>http://10.0.1.67:2380,master3<span class="o">=</span>http://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master3</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master3
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.236
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>http://10.0.1.204:2380,master2<span class="o">=</span>http://10.0.1.67:2380,master3<span class="o">=</span>http://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>
  </li>
  <li>
    <p>编辑systemd服务文件 /usr/lib/systemd/etcd.service(rhel系列的)或者/lib/systemd/system/etcd.service(ubuntu系列)</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target
  
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/data/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2"> /opt/etcd/etcd </span><span class="se">\</span><span class="s2">
          --data-dir </span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2"> </span><span class="se">\-</span><span class="s2">-name </span><span class="se">\"</span><span class="k">${</span><span class="nv">HOST_NAME</span><span class="k">}</span><span class="se">\"</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-advertise-peer-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --listen-peer-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --advertise-client-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-client-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --initial-cluster </span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-state </span><span class="k">${</span><span class="nv">CLUSTER_STATE</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-token </span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536
  
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl start etcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcdctl endpoint health
</code></pre></div>    </div>

    <p>注意：etcdctl endpoint health命令不加参数的话，默认是访问本地的2379端口，也就是127.0.0.1：2379，但是咱们刚才配置集群的时候是没有监听本地端口的，所以要使用<code class="highlighter-rouge">--endpoint</code>命令指定端口。否则会报错</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:2379 is unhealthy: failed to commit proposal: context deadline exceeded
</code></pre></div>    </div>

    <p>可悲的是，如果使用endpoint参数，就必须使用https协议，也就是必须使用证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcdctl <span class="nt">--endpoints</span><span class="o">=</span>https://10.0.1.236:2379 <span class="nt">--cacert</span><span class="o">=</span>/etc/k8s/ssl/etcd-root-ca.pem <span class="nt">--key</span><span class="o">=</span>/etc/k8s/ssl/etcd-key.pem  <span class="nt">--cert</span><span class="o">=</span>/etc/k8s/ssl/etcd.pem  endpoint health 
</code></pre></div>    </div>

    <p>我们目前还没配置证书，只能从日志中查看etcd的状态是否正常</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>journalctl <span class="nt">-u</span> etcd
</code></pre></div>    </div>

    <p>而etcd的输出位置是没有参数去指定的，他的默认输出是stdout，会由journald来管理</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Logging:
  <span class="nt">--logger</span> <span class="s1">'capnslog'</span>
    Specify <span class="s1">'zap'</span> <span class="k">for </span>structured logging or <span class="s1">'capnslog'</span><span class="nb">.</span> <span class="o">[</span>WARN] <span class="s1">'capnslog'</span> will be deprecated <span class="k">in </span>v3.5.
  <span class="nt">--log-outputs</span> <span class="s1">'default'</span>
    Specify <span class="s1">'stdout'</span> or <span class="s1">'stderr'</span> to skip journald logging even when running under systemd, or list of comma separated output targets.
  <span class="nt">--log-level</span> <span class="s1">'info'</span>
    Configures log level. Only supports debug, info, warn, error, panic, or fatal.
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="4-配置安全的etcd">4. 配置安全的etcd</h2>

<h3 id="41-制作证书">4.1. 制作证书</h3>

<p><a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/">制作证书</a>目前普遍使用这三种工具，<code class="highlighter-rouge">easyrsa</code>, <code class="highlighter-rouge">openssl</code> 或者 <code class="highlighter-rouge">cfssl</code>，我们这里使用cfssl，参考<a href="https://github.com/coreos/docs/blob/master/os/generate-self-signed-certificates.md">github</a></p>

<h4 id="411-准备环境">4.1.1. 准备环境</h4>

<ul>
  <li>
    <p>下载cfssl工具</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nt">-o</span> /usr/local/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nt">-o</span> /usr/local/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod +x /usr/local/bin/<span class="o">{</span>cfssl,cfssljson<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>测试一下</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cfssl
No <span class="nb">command </span>is given.
Usage:
Available commands:
	serve
	version
	genkey
	gencrl
	ocsprefresh
	selfsign
	scan
	print-defaults
	revoke
	bundle
	sign
	gencert
	ocspdump
	ocspserve
	info
	certinfo
	ocspsign
Top-level flags:
  <span class="nt">-allow_verification_with_non_compliant_keys</span>
    	Allow a SignatureVerifier to use keys which are technically non-compliant with RFC6962.
  <span class="nt">-loglevel</span> int
    	Log level <span class="o">(</span>0 <span class="o">=</span> DEBUG, 5 <span class="o">=</span> FATAL<span class="o">)</span> <span class="o">(</span>default 1<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建工作目录</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir <span class="nt">-p</span> /etc/kubernetes/pki/etcd
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="412-创建ca相关证书">4.1.2. 创建CA相关证书</h4>

<ul>
  <li>
    <p>创建CA配置文件（默认创建）</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/kubernetes/pki/etcd
cfssl print-defaults config <span class="o">&gt;</span> ca-config.json
cfssl print-defaults csr <span class="o">&gt;</span> ca-csr.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改<code class="highlighter-rouge">ca-config.json</code>为</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"server"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"server auth"</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"client"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"client auth"</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"peer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"client auth"</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>修改<code class="highlighter-rouge">ca-csr.json</code>为</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"My own CA"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"My Company Name"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Org Unit 1"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Org Unit 2"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>创建CA的证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-initca</span> ca-csr.json | cfssljson <span class="nt">-bare</span> ca -
</code></pre></div>    </div>
  </li>
  <li>
    <p>会得到三个文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ca-key.pem
ca.csr
ca.pem
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="413-创建服务器server相关证书">4.1.3. 创建服务器（server）相关证书</h4>

<ul>
  <li>
    <p>生成配置文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl print-defaults csr <span class="o">&gt;</span> server.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改server.json中CN和host的部分</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.204"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.67"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.236"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ecdsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>生成证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-ca</span><span class="o">=</span>ca.pem <span class="nt">-ca-key</span><span class="o">=</span>ca-key.pem <span class="nt">-config</span><span class="o">=</span>ca-config.json <span class="nt">-profile</span><span class="o">=</span>server server.json | cfssljson <span class="nt">-bare</span> server
</code></pre></div>    </div>
  </li>
  <li>
    <p>同样是三个文件（这个是服务器启动时候的证书）</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server-key.pem
server.csr
server.pem
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="414-创建服务器互相通讯peer的相关证书">4.1.4. 创建服务器互相通讯（peer）的相关证书</h4>

<ul>
  <li>
    <p>生成配置文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl print-defaults csr <span class="o">&gt;</span> peer.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改server.json中CN和host的部分</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"peer"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.204"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.67"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.236"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ecdsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>生成证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-ca</span><span class="o">=</span>ca.pem <span class="nt">-ca-key</span><span class="o">=</span>ca-key.pem <span class="nt">-config</span><span class="o">=</span>ca-config.json <span class="nt">-profile</span><span class="o">=</span>peer members.json | cfssljson <span class="nt">-bare</span> members
</code></pre></div>    </div>
  </li>
  <li>
    <p>三个文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer-key.pem
peer.csr
peer.pem
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="415-创建客户端client的相关证书">4.1.5. 创建客户端（client）的相关证书</h4>

<ul>
  <li>
    <p>生成配置文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl print-defaults csr <span class="o">&gt;</span> client.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改server.json中CN和host的部分</p>

    <p>注意：一般来说，如果etcd需要手动创建的话，架构上会把这三台etcd独立拿出来作为数据库来管理，所以客户端会的hosts是etcd之外的IP地址，但是我们这里实验是使用这三台etcd作为客户端的，所以地址还是这三台机器。如果实在不明白，就把所有的机器ip<strong>和</strong>DNS名称都写在这个hosts里面，或者让hosts留空(下面的例子)，防止出错，不过这样并不算最安全的选择。</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"client"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">""</span><span class="p">],</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ecdsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>生成证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-ca</span><span class="o">=</span>ca.pem <span class="nt">-ca-key</span><span class="o">=</span>ca-key.pem <span class="nt">-config</span><span class="o">=</span>ca-config.json <span class="nt">-profile</span><span class="o">=</span>client client.json | cfssljson <span class="nt">-bare</span> client
</code></pre></div>    </div>
  </li>
  <li>
    <p>又得到一组证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>client-key.pem
client.csr
client.pem
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="42-配置etcd使用ssl证书">4.2. 配置etcd使用ssl证书</h3>

<ul>
  <li>
    <p>把刚才生成的所有证书(在/etc/kubernetes/pki/etcd下的所有文件)都复制到另外的etcd机器上去。</p>
  </li>
  <li>
    <p>修改启动文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target
  
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/data/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2"> /opt/etcd/etcd </span><span class="se">\</span><span class="s2">
          --data-dir </span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --name </span><span class="k">${</span><span class="nv">HOST_NAME</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-advertise-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --listen-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --advertise-client-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-client-urls https://127.0.0.1:2379,https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-metrics-urls=http://127.0.0.1:2381 </span><span class="se">\</span><span class="s2">
          --initial-cluster </span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-state </span><span class="k">${</span><span class="nv">CLUSTER_STATE</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-token </span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --client-cert-auth </span><span class="se">\</span><span class="s2">
          --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --cert-file=/etc/kubernetes/pki/etcd/server.pem </span><span class="se">\</span><span class="s2">
          --key-file=/etc/kubernetes/pki/etcd/server-key.pem </span><span class="se">\</span><span class="s2">
          --peer-client-cert-auth </span><span class="se">\</span><span class="s2">
          --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --peer-cert-file=/etc/kubernetes/pki/etcd/peer.pem </span><span class="se">\</span><span class="s2">
Restart=on-failure
LimitNOFILE=65536
  
[Install]
WantedBy=multi-user.target
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>修改配置文件，/etc/etcd/etcd.conf</p>

    <p>master1</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master1
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.204
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>https://10.0.1.204:2380,master2<span class="o">=</span>https://10.0.1.67:2380,master3<span class="o">=</span>https://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master2</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master2
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.67
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>https://10.0.1.204:2380,master2<span class="o">=</span>https://10.0.1.67:2380,master3<span class="o">=</span>https://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master3</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master3
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.236
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>https://10.0.1.204:2380,master2<span class="o">=</span>https://10.0.1.67:2380,master3<span class="o">=</span>https://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改权限</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod 400 /etc/kubernetes/pki/etcd/<span class="k">*</span>
chown <span class="nt">-R</span> etcd:adm /etc/kubernetes/pki/etcd/
</code></pre></div>    </div>
  </li>
  <li>
    <p>重启启动集群会报错</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error <span class="s2">"tls: first record does not look like a TLS handshake
</span></code></pre></div>    </div>

    <p>删除数据文件，重新启动就好了</p>
  </li>
</ul>



      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
