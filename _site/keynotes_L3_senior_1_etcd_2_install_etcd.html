<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" keynotes, senior, etcd, install_etcd">
<title>安装etcd | CloudNative knowledge</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="cloudnative365.gitpage.io" href="http://0.0.0.0:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> 云原生技术课堂</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">课程<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="lessons_syllabus.html">教学大纲</a></li>
                        
                        
                        
                        <li><a href="lessons_plans.html">开课计划</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">课堂笔记<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="keynotes_L1_basic.html">基础课程</a></li>
                        
                        
                        
                        <li><a href="keynotes_L2_advanced.html">进阶课程</a></li>
                        
                        
                        
                        <li><a href="keynotes_L3_senior.html">高级课程</a></li>
                        
                        
                        
                        <li><a href="keynotes_L4_architect.html">架构师课程</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">课堂风采<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="classes_teachers.html">讲师风采</a></li>
                        
                        
                        
                        <li><a href="classes_aboutus.html">关于我们</a></li>
                        
                        
                        
                        <li><a href="classes_successd.html">优秀学员作品</a></li>
                        
                        
                    </ul>
                </li>
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">常用链接<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://www.cncf.io/" target="_blank" rel="noopener">CNCF Foundation</a></li>
                        
                        
                        
                        <li><a href="https://www.linuxfoundation.org/" target="_blank" rel="noopener">Linux Foundation</a></li>
                        
                        
                        
                        <li><a href="https://cd.foundation/" target="_blank" rel="noopener">CD Foundation</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="安装etcd">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">高级课程 </li>
  
  
  
      
  
  <li>
      <a title="1.etcd" href="#">1.etcd</a>
      <ul>
          
          
          
          <li><a title="1.etcd概览" href="keynotes_L3_senior_1_etcd_1_etcd_overview.html">1.etcd概览</a></li>
          
          
          
          
          
          
          <li class="active"><a title="2.安装etcd" href="keynotes_L3_senior_1_etcd_2_install_etcd.html">2.安装etcd</a></li>
          
          
          
          
          
          
          <li><a title="3.使用kubeadm安装etcd" href="keynotes_L3_senior_1_etcd_3_install_etcd_with_kubeadm.html">3.使用kubeadm安装etcd</a></li>
          
          
          
          
          
          
          <li><a title="4.管理etcd集群" href="keynotes_L3_senior_1_etcd_4_manage_etcd.html">4.管理etcd集群</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="2.kubernetes集群管理" href="#">2.kubernetes集群管理</a>
      <ul>
          
          
          
          <li><a title="1.使用kubeadm安装kubernetes集群（外挂etcd）" href="keynotes_L3_senior_2_kubernetes_1_install_kubernetes_kubeadm.html">1.使用kubeadm安装kubernetes集群（外挂etcd）</a></li>
          
          
          
          
          
          
          <li><a title="2.比hard way还hard的方式安装kubernetes集群" href="keynotes_L3_senior_2_kubernetes_2_hardest_way.html">2.比hard way还hard的方式安装kubernetes集群</a></li>
          
          
          
          
          
          
          <li><a title="3.keynotes_L3_senior_2_kubernetes_3_manage_kubernetes.html" href="mydoc_introduction.html">3.keynotes_L3_senior_2_kubernetes_3_manage_kubernetes.html</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="3.ingress" href="#">3.ingress</a>
      <ul>
          
          
          
          <li><a title="1.ingress" href="keynotes_L3_senior_2_kubernetes_1_ingress.html">1.ingress</a></li>
          
          
          
          
          
          
          <li><a title="2.安装ingress-nginx" href="keynotes_L3_senior_2_kubernetes_2_install_ingress_nginx.html">2.安装ingress-nginx</a></li>
          
          
          
          
          
          
          <li><a title="3.安装ingress-envoy" href="keynotes_L3_senior_2_kubernetes_3_install_ingress_envoy.html">3.安装ingress-envoy</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="4.helm" href="#">4.helm</a>
      <ul>
          
          
          
          <li><a title="1.helm简介" href="keynotes_L3_senior_2_kubernetes_1_helm.html">1.helm简介</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a title="5.Rancher" href="#">5.Rancher</a>
      <ul>
          
          
          
          <li><a title="1.Rancher简介" href="keynotes_L3_senior_2_kubernetes_1_Rancher.html">1.Rancher简介</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">安装etcd</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

   <h2 id="课程目标">课程目标</h2>

<ul>
  <li>安装单机版etcd</li>
  <li>安装etcd集群</li>
  <li>配置安全的etcd（配置SSL证书）</li>
</ul>

<h2 id="1-环境">1. 环境</h2>

<h3 id="11-软件版本">1.1. 软件版本</h3>

<table>
  <thead>
    <tr>
      <th>环境</th>
      <th>版本</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>操作系统</td>
      <td>linux大部分发行版都可以（ubuntu/rhel/centos）</td>
    </tr>
    <tr>
      <td>内核版本</td>
      <td>3.10和4.15</td>
    </tr>
    <tr>
      <td>etcd</td>
      <td>v3.4.9</td>
    </tr>
    <tr>
      <td>golang</td>
      <td>1.14.3</td>
    </tr>
  </tbody>
</table>

<h3 id="12-硬件规划">1.2. 硬件规划</h3>

<p>关于机器选项可以参考<a href="https://etcd.io/docs/v3.4.0/op-guide/hardware/#example-hardware-configurations">这个</a></p>

<p>Here are a few example hardware setups on AWS and GCE environments. As mentioned before, but must be stressed regardless, administrators should test an etcd deployment with a simulated workload before putting it into production.</p>

<p>Note that these configurations assume these machines are totally dedicated to etcd. Running other applications along with etcd on these machines may cause resource contentions and lead to cluster instability.</p>

<h3 id="small-cluster">Small cluster</h3>

<p>A small cluster serves fewer than 100 clients, fewer than 200 of requests per second, and stores no more than 100MB of data.</p>

<p>Example application workload: A 50-node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.large</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">3600</td>
      <td style="text-align: left">56.25</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-2 + 50GB PD SSD</td>
      <td style="text-align: left">2</td>
      <td style="text-align: left">7.5</td>
      <td style="text-align: left">1500</td>
      <td style="text-align: left">25</td>
    </tr>
  </tbody>
</table>

<h3 id="medium-cluster">Medium cluster</h3>

<p>A medium cluster serves fewer than 500 clients, fewer than 1,000 of requests per second, and stores no more than 500MB of data.</p>

<p>Example application workload: A 250-node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.xlarge</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">6000</td>
      <td style="text-align: left">93.75</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-4 + 150GB PD SSD</td>
      <td style="text-align: left">4</td>
      <td style="text-align: left">15</td>
      <td style="text-align: left">4500</td>
      <td style="text-align: left">75</td>
    </tr>
  </tbody>
</table>

<h3 id="large-cluster">Large cluster</h3>

<p>A large cluster serves fewer than 1,500 clients, fewer than 10,000 of requests per second, and stores no more than 1GB of data.</p>

<p>Example application workload: A 1,000-node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.2xlarge</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">32</td>
      <td style="text-align: left">8000</td>
      <td style="text-align: left">125</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-8 + 250GB PD SSD</td>
      <td style="text-align: left">8</td>
      <td style="text-align: left">30</td>
      <td style="text-align: left">7500</td>
      <td style="text-align: left">125</td>
    </tr>
  </tbody>
</table>

<h3 id="xlarge-cluster">xLarge cluster</h3>

<p>An xLarge cluster serves more than 1,500 clients, more than 10,000 of requests per second, and stores more than 1GB data.</p>

<p>Example application workload: A 3,000 node Kubernetes cluster</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Provider</th>
      <th style="text-align: left">Type</th>
      <th style="text-align: left">vCPUs</th>
      <th style="text-align: left">Memory (GB)</th>
      <th style="text-align: left">Max concurrent IOPS</th>
      <th style="text-align: left">Disk bandwidth (MB/s)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">AWS</td>
      <td style="text-align: left">m4.4xlarge</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">64</td>
      <td style="text-align: left">16,000</td>
      <td style="text-align: left">250</td>
    </tr>
    <tr>
      <td style="text-align: left">GCE</td>
      <td style="text-align: left">n1-standard-16 + 500GB PD SSD</td>
      <td style="text-align: left">16</td>
      <td style="text-align: left">60</td>
      <td style="text-align: left">15,000</td>
      <td style="text-align: left">250</td>
    </tr>
  </tbody>
</table>

<h2 id="2-安装单机版etcd">2. 安装单机版etcd</h2>

<h3 id="21-二进制包安装etcd">2.1. 二进制包安装etcd</h3>

<ul>
  <li>
    <p>下载和解压</p>

    <p><a href="https://github.com/etcd-io/etcd/releases/">这里</a>有下载的向导，也可以点这里直接下载<a href="https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz">v3.4.9</a></p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#设置要下载的版本</span>
<span class="nv">ETCD_VER</span><span class="o">=</span>v3.4.9
<span class="nv">INSTALL_DIR</span><span class="o">=</span>/opt
  
<span class="c"># 也可以从google下载，鉴于国内无法访问，就注释掉了</span>
<span class="c"># GOOGLE_URL=https://storage.googleapis.com/etcd</span>
<span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/etcd-io/etcd/releases/download
<span class="nv">DOWNLOAD_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">GITHUB_URL</span><span class="k">}</span>
  
<span class="c"># 清理原来下载过的</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="o">&amp;&amp;</span> mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd
  
<span class="c"># 下载</span>
curl <span class="nt">-L</span> <span class="k">${</span><span class="nv">DOWNLOAD_URL</span><span class="k">}</span>/<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-o</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar </span>xzvf <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-C</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="nt">--strip-components</span><span class="o">=</span>1
<span class="c"># 删除压缩包</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
  
<span class="c"># 测试</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcd <span class="nt">--version</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcdctl version
  
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动etcd</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./etcd
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="22-编译安装etcd">2.2. 编译安装etcd</h3>

<ul>
  <li>
    <p>官方文档在<a href="https://etcd.io/docs/v3.4.0/dl-build/">这里</a></p>
  </li>
  <li>
    <p>注意：编译安装的话需要安装1.14版本及以上的golang环境，下载golang的二进制包，配置GOROOT和GOPATH</p>
  </li>
  <li>
    <p>注意：官网要求golang版本是1.13以上（也就是1.14版本），目前的镜像只有RHEL8.2和AMAZON linux2的yum源中的golang是1.13版本，换句话说，截止2020年5月27日，如果想编译安装etcd，必须自己手动配置golang环境</p>
  </li>
  <li>
    <p>注意：目前版本上使用编译后的etcd创建集群的时候会出现错误，目前测试在AWS的linux2上会出现这个问题，所以只有二进制方式安装最保险</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>panic: runtime error: invalid memory address or nil pointer dereference
</code></pre></div>    </div>
  </li>
  <li>
    <p>下载golang</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 国内无法访问google，请使用下面的链接下载二进制包</span>
wget https://studygolang.com/dl/golang/go1.14.3.linux-amd64.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar </span>xf go1.14.3.linux-amd64.tar.gz
<span class="c"># 验证</span>
./go/bin/go version
go version go1.14.3 linux/amd64
</code></pre></div>    </div>
  </li>
  <li>
    <p>配置go环境</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/profile.d/golong.sh
export GOROOT=/opt/go
export PATH=</span><span class="nv">$PATH</span><span class="sh">:/opt/go/bin
</span><span class="no">EOF
  
</span><span class="nb">source</span> /etc/profile
</code></pre></div>    </div>
  </li>
  <li>
    <p>编译</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://github.com/etcd-io/etcd.git
<span class="nv">$ </span><span class="nb">cd </span>etcd
<span class="nv">$ </span>go env <span class="nt">-w</span> <span class="nv">GOPROXY</span><span class="o">=</span>https://goproxy.cn,direct
<span class="nv">$ </span>go mod vendor
<span class="nv">$ </span>./build
</code></pre></div>    </div>
  </li>
  <li>
    <p>验证</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 在bin目录下面会多出两个可执行文件</span>
<span class="nb">ls </span>bin/
etcd  etcdctl
  
<span class="c"># 查看版本</span>
<span class="nv">$ </span>./bin/etcd <span class="nt">--version</span>
etcd Version: 3.5.0-pre
Git SHA: 9b6c3e337
Go Version: go1.14.3
Go OS/Arch: linux/amd64
  
<span class="nv">$ </span>./bin/etcdctl version
etcdctl version: 3.5.0-pre
API version: 3.5
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="3-安装etcd集群">3. 安装etcd集群</h2>

<p>如果是简单的demo，我们可以参考<a href="https://etcd.io/docs/v3.4.0/demo/">官方文档</a>。这里介绍的是在生产环境上搭建etcd集群。</p>

<h3 id="31-准备环境">3.1. 准备环境</h3>

<ul>
  <li>
    <p>配置时间服务，ntpd和chrony都可以</p>
  </li>
  <li>
    <p>为etcd创建独立的文件系统，在公有云环境中，系统基本都是镜像启动的，实例被干掉之后容易丢数据，而且速度不如外挂存储卷，且稳定性好。</p>

    <p>注意：不管我们的数据放在哪里，都有丢失的危险，一定要记得备份！etcd再轻量也是数据库，数据丢了，什么都没了</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lvcreate <span class="nt">-n</span> lv_etcd <span class="nt">-L</span> 10G vg_system
<span class="nv">$ </span>mkfs.xfs /dev/mapper/vg_system-lv_etcd
<span class="nv">$ </span>mkdir <span class="nt">-p</span> /data/etcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>权限控制</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建etcd用户，只用来跑程序</span>
<span class="nv">$ </span>useradd etcd
<span class="c"># 修改etcd的主要组为adm，便于同属于adm组的管理员查看，并且指定不可以登录</span>
<span class="nv">$ </span>usermod <span class="nt">-g</span> adm <span class="nt">-s</span> nologin etcd
<span class="c"># 修改数据的权限，etcd用户拥有所有的权限</span>
<span class="c"># etcd所在的组adm拥有读和执行的权限，方便管理员查看或者备份，也可以给他只读权限</span>
<span class="c"># 其他人员没有权限</span>
<span class="c"># root拥有所有权限</span>
<span class="nv">$ </span>chmod 740 /data/etcd
<span class="nv">$ </span>chown etcd:adm /data/etcd
<span class="nv">$ </span>mkdir /etc/etcd
<span class="nv">$ </span>chmod 740 /data/etcd
<span class="nv">$ </span>chown etcd:adm /etc/etcd
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="32-二进制包安装etcd">3.2. 二进制包安装etcd</h3>

<ul>
  <li>
    <p>下载和解压</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#设置要下载的版本</span>
<span class="nv">ETCD_VER</span><span class="o">=</span>v3.4.9
<span class="nv">INSTALL_DIR</span><span class="o">=</span>/opt
  
<span class="c"># 也可以从google下载，鉴于国内无法访问，就注释掉了</span>
<span class="c"># GOOGLE_URL=https://storage.googleapis.com/etcd</span>
<span class="nv">GITHUB_URL</span><span class="o">=</span>https://github.com/etcd-io/etcd/releases/download
<span class="nv">DOWNLOAD_URL</span><span class="o">=</span><span class="k">${</span><span class="nv">GITHUB_URL</span><span class="k">}</span>
  
<span class="c"># 清理原来下载过的</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
rm <span class="nt">-rf</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="o">&amp;&amp;</span> mkdir <span class="nt">-p</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd
  
<span class="c"># 下载</span>
curl <span class="nt">-L</span> <span class="k">${</span><span class="nv">DOWNLOAD_URL</span><span class="k">}</span>/<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-o</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
<span class="c"># 解压</span>
<span class="nb">tar </span>xzvf <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz <span class="nt">-C</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd <span class="nt">--strip-components</span><span class="o">=</span>1
<span class="c"># 删除压缩包</span>
rm <span class="nt">-f</span> <span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd-<span class="k">${</span><span class="nv">ETCD_VER</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
  
<span class="c"># 测试</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcd <span class="nt">--version</span>
<span class="k">${</span><span class="nv">INSTALL_DIR</span><span class="k">}</span>/etcd/etcdctl version
</code></pre></div>    </div>
  </li>
  <li>
    <p>配置etcd的路径</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt; /etc/profile.d/etcd.sh
export PATH=</span><span class="nv">$PATH</span><span class="sh">:/opt/etcd
</span><span class="no">EOF
  
</span><span class="nb">source</span> /etc/profile
</code></pre></div>    </div>
  </li>
  <li>
    <p>生成一个长一点的token保证安全</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo </span>k8s-cluster|md5sum
ea8cfe2bfe85b7e6c66fe190f9225838  -
</code></pre></div>    </div>
  </li>
  <li>
    <p>配置文件/etc/etcd/etcd.conf</p>

    <p>master1</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master1
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.204
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>http://10.0.1.204:2380,master2<span class="o">=</span>http://10.0.1.67:2380,master3<span class="o">=</span>http://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master2</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master2
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.67
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>http://10.0.1.204:2380,master2<span class="o">=</span>http://10.0.1.67:2380,master3<span class="o">=</span>http://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master3</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master3
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.236
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>http://10.0.1.204:2380,master2<span class="o">=</span>http://10.0.1.67:2380,master3<span class="o">=</span>http://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>
  </li>
  <li>
    <p>编辑systemd服务文件 /usr/lib/systemd/etcd.service(rhel系列的)或者/lib/systemd/system/etcd.service(ubuntu系列)</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target
  
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/data/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2"> /opt/etcd/etcd </span><span class="se">\</span><span class="s2">
          --data-dir </span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2"> </span><span class="se">\-</span><span class="s2">-name </span><span class="se">\"</span><span class="k">${</span><span class="nv">HOST_NAME</span><span class="k">}</span><span class="se">\"</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-advertise-peer-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --listen-peer-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --advertise-client-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-client-urls http://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --initial-cluster </span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-state </span><span class="k">${</span><span class="nv">CLUSTER_STATE</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-token </span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2">"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536
  
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div>    </div>
  </li>
  <li>
    <p>启动</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl start etcd
</code></pre></div>    </div>
  </li>
  <li>
    <p>查看状态</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcdctl endpoint health
</code></pre></div>    </div>

    <p>注意：etcdctl endpoint health命令不加参数的话，默认是访问本地的2379端口，也就是127.0.0.1：2379，但是咱们刚才配置集群的时候是没有监听本地端口的，所以要使用<code class="highlighter-rouge">--endpoint</code>命令指定端口。否则会报错</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:2379 is unhealthy: failed to commit proposal: context deadline exceeded
</code></pre></div>    </div>

    <p>可悲的是，如果使用endpoint参数，就必须使用https协议，也就是必须使用证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcdctl <span class="nt">--endpoints</span><span class="o">=</span>https://10.0.1.236:2379 <span class="nt">--cacert</span><span class="o">=</span>/etc/k8s/ssl/etcd-root-ca.pem <span class="nt">--key</span><span class="o">=</span>/etc/k8s/ssl/etcd-key.pem  <span class="nt">--cert</span><span class="o">=</span>/etc/k8s/ssl/etcd.pem  endpoint health 
</code></pre></div>    </div>

    <p>我们目前还没配置证书，只能从日志中查看etcd的状态是否正常</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>journalctl <span class="nt">-u</span> etcd
</code></pre></div>    </div>

    <p>而etcd的输出位置是没有参数去指定的，他的默认输出是stdout，会由journald来管理</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Logging:
  <span class="nt">--logger</span> <span class="s1">'capnslog'</span>
    Specify <span class="s1">'zap'</span> <span class="k">for </span>structured logging or <span class="s1">'capnslog'</span><span class="nb">.</span> <span class="o">[</span>WARN] <span class="s1">'capnslog'</span> will be deprecated <span class="k">in </span>v3.5.
  <span class="nt">--log-outputs</span> <span class="s1">'default'</span>
    Specify <span class="s1">'stdout'</span> or <span class="s1">'stderr'</span> to skip journald logging even when running under systemd, or list of comma separated output targets.
  <span class="nt">--log-level</span> <span class="s1">'info'</span>
    Configures log level. Only supports debug, info, warn, error, panic, or fatal.
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="4-配置安全的etcd">4. 配置安全的etcd</h2>

<h3 id="41-制作证书">4.1. 制作证书</h3>

<p><a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/">制作证书</a>目前普遍使用这三种工具，<code class="highlighter-rouge">easyrsa</code>, <code class="highlighter-rouge">openssl</code> 或者 <code class="highlighter-rouge">cfssl</code>，我们这里使用cfssl，参考<a href="https://github.com/coreos/docs/blob/master/os/generate-self-signed-certificates.md">github</a></p>

<h4 id="411-准备环境">4.1.1. 准备环境</h4>

<ul>
  <li>
    <p>下载cfssl工具</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nt">-o</span> /usr/local/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64
curl <span class="nt">-s</span> <span class="nt">-L</span> <span class="nt">-o</span> /usr/local/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64
chmod +x /usr/local/bin/<span class="o">{</span>cfssl,cfssljson<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>测试一下</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cfssl
No <span class="nb">command </span>is given.
Usage:
Available commands:
	serve
	version
	genkey
	gencrl
	ocsprefresh
	selfsign
	scan
	print-defaults
	revoke
	bundle
	sign
	gencert
	ocspdump
	ocspserve
	info
	certinfo
	ocspsign
Top-level flags:
  <span class="nt">-allow_verification_with_non_compliant_keys</span>
    	Allow a SignatureVerifier to use keys which are technically non-compliant with RFC6962.
  <span class="nt">-loglevel</span> int
    	Log level <span class="o">(</span>0 <span class="o">=</span> DEBUG, 5 <span class="o">=</span> FATAL<span class="o">)</span> <span class="o">(</span>default 1<span class="o">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>创建工作目录</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir <span class="nt">-p</span> /etc/kubernetes/pki/etcd
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="412-创建ca相关证书">4.1.2. 创建CA相关证书</h4>

<ul>
  <li>
    <p>创建CA配置文件（默认创建）</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/kubernetes/pki/etcd
cfssl print-defaults config <span class="o">&gt;</span> ca-config.json
cfssl print-defaults csr <span class="o">&gt;</span> ca-csr.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改<code class="highlighter-rouge">ca-config.json</code>为</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"server"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"server auth"</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"client"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"client auth"</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"peer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"43800h"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"client auth"</span><span class="w">
                </span><span class="p">]</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>修改<code class="highlighter-rouge">ca-csr.json</code>为</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"My own CA"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"My Company Name"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Org Unit 1"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Org Unit 2"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>创建CA的证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-initca</span> ca-csr.json | cfssljson <span class="nt">-bare</span> ca -
</code></pre></div>    </div>
  </li>
  <li>
    <p>会得到三个文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ca-key.pem
ca.csr
ca.pem
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="413-创建服务器server相关证书">4.1.3. 创建服务器（server）相关证书</h4>

<ul>
  <li>
    <p>生成配置文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl print-defaults csr <span class="o">&gt;</span> server.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改server.json中CN和host的部分</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.204"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.67"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.236"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ecdsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>生成证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-ca</span><span class="o">=</span>ca.pem <span class="nt">-ca-key</span><span class="o">=</span>ca-key.pem <span class="nt">-config</span><span class="o">=</span>ca-config.json <span class="nt">-profile</span><span class="o">=</span>server server.json | cfssljson <span class="nt">-bare</span> server
</code></pre></div>    </div>
  </li>
  <li>
    <p>同样是三个文件（这个是服务器启动时候的证书）</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server-key.pem
server.csr
server.pem
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="414-创建服务器互相通讯peer的相关证书">4.1.4. 创建服务器互相通讯（peer）的相关证书</h4>

<ul>
  <li>
    <p>生成配置文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl print-defaults csr <span class="o">&gt;</span> peer.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改server.json中CN和host的部分</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"peer"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.204"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.67"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.0.1.236"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ecdsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>生成证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-ca</span><span class="o">=</span>ca.pem <span class="nt">-ca-key</span><span class="o">=</span>ca-key.pem <span class="nt">-config</span><span class="o">=</span>ca-config.json <span class="nt">-profile</span><span class="o">=</span>peer members.json | cfssljson <span class="nt">-bare</span> members
</code></pre></div>    </div>
  </li>
  <li>
    <p>三个文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer-key.pem
peer.csr
peer.pem
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="415-创建客户端client的相关证书">4.1.5. 创建客户端（client）的相关证书</h4>

<ul>
  <li>
    <p>生成配置文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl print-defaults csr <span class="o">&gt;</span> client.json
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改server.json中CN和host的部分</p>

    <p>注意：一般来说，如果etcd需要手动创建的话，架构上会把这三台etcd独立拿出来作为数据库来管理，所以客户端会的hosts是etcd之外的IP地址，但是我们这里实验是使用这三台etcd作为客户端的，所以地址还是这三台机器。如果实在不明白，就把所有的机器ip<strong>和</strong>DNS名称都写在这个hosts里面，或者让hosts留空(下面的例子)，防止出错，不过这样并不算最安全的选择。</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"client"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">""</span><span class="p">],</span><span class="w">
    </span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ecdsa"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"US"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"San Francisco"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>生成证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">-ca</span><span class="o">=</span>ca.pem <span class="nt">-ca-key</span><span class="o">=</span>ca-key.pem <span class="nt">-config</span><span class="o">=</span>ca-config.json <span class="nt">-profile</span><span class="o">=</span>client client.json | cfssljson <span class="nt">-bare</span> client
</code></pre></div>    </div>
  </li>
  <li>
    <p>又得到一组证书</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>client-key.pem
client.csr
client.pem
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="42-配置etcd使用ssl证书">4.2. 配置etcd使用ssl证书</h3>

<ul>
  <li>
    <p>把刚才生成的所有证书(在/etc/kubernetes/pki/etcd下的所有文件)都复制到另外的etcd机器上去。</p>
  </li>
  <li>
    <p>修改启动文件</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target
  
<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/data/etcd
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2"> /opt/etcd/etcd </span><span class="se">\</span><span class="s2">
          --data-dir </span><span class="k">${</span><span class="nv">DATA_DIR</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --name </span><span class="k">${</span><span class="nv">HOST_NAME</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-advertise-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --listen-peer-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2380 </span><span class="se">\</span><span class="s2">
          --advertise-client-urls https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-client-urls https://127.0.0.1:2379,https://</span><span class="k">${</span><span class="nv">HOST_IP</span><span class="k">}</span><span class="s2">:2379 </span><span class="se">\</span><span class="s2">
          --listen-metrics-urls=http://127.0.0.1:2381 </span><span class="se">\</span><span class="s2">
          --initial-cluster </span><span class="k">${</span><span class="nv">CLUSTER</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-state </span><span class="k">${</span><span class="nv">CLUSTER_STATE</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --initial-cluster-token </span><span class="k">${</span><span class="nv">TOKEN</span><span class="k">}</span><span class="s2"> </span><span class="se">\</span><span class="s2">
          --client-cert-auth </span><span class="se">\</span><span class="s2">
          --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --cert-file=/etc/kubernetes/pki/etcd/server.pem </span><span class="se">\</span><span class="s2">
          --key-file=/etc/kubernetes/pki/etcd/server-key.pem </span><span class="se">\</span><span class="s2">
          --peer-client-cert-auth </span><span class="se">\</span><span class="s2">
          --peer-trusted-ca-file=/etc/kubernetes/pki/etcd/ca.pem </span><span class="se">\</span><span class="s2">
          --peer-cert-file=/etc/kubernetes/pki/etcd/peer.pem </span><span class="se">\</span><span class="s2">
Restart=on-failure
LimitNOFILE=65536
  
[Install]
WantedBy=multi-user.target
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>修改配置文件，/etc/etcd/etcd.conf</p>

    <p>master1</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master1
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.204
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>https://10.0.1.204:2380,master2<span class="o">=</span>https://10.0.1.67:2380,master3<span class="o">=</span>https://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master2</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master2
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.67
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>https://10.0.1.204:2380,master2<span class="o">=</span>https://10.0.1.67:2380,master3<span class="o">=</span>https://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>

    <p>master3</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DATA_DIR</span><span class="o">=</span>/data/etcd
<span class="nv">HOST_NAME</span><span class="o">=</span>master3
<span class="nv">HOST_IP</span><span class="o">=</span>10.0.1.236
<span class="nv">CLUSTER</span><span class="o">=</span><span class="nv">master1</span><span class="o">=</span>https://10.0.1.204:2380,master2<span class="o">=</span>https://10.0.1.67:2380,master3<span class="o">=</span>https://10.0.1.236:2380
<span class="nv">CLUSTER_STATE</span><span class="o">=</span>new
<span class="nv">TOKEN</span><span class="o">=</span>ea8cfe2bfe85b7e6c66fe190f9225838
</code></pre></div>    </div>
  </li>
  <li>
    <p>修改权限</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod 400 /etc/kubernetes/pki/etcd/<span class="k">*</span>
chown <span class="nt">-R</span> etcd:adm /etc/kubernetes/pki/etcd/
</code></pre></div>    </div>
  </li>
  <li>
    <p>重启启动集群会报错</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error <span class="s2">"tls: first record does not look like a TLS handshake
</span></code></pre></div>    </div>

    <p>删除数据文件，重新启动就好了</p>
  </li>
</ul>



    <div class="tags">
        
    </div>


<div id="commento"></div>
<script src="https://cdn.commento.io/js/commento.js"></script>
<noscript>Please enable JavaScript to load the comments.</noscript>



</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2020 原生云技术. All rights reserved. <br />
 Site last generated: Jun 29, 2020 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
