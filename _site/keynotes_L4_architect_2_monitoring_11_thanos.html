<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>thanos | cloudnative365.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="thanos" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/keynotes_L4_architect_2_monitoring_11_thanos.html" />
<meta property="og:url" content="http://localhost:4000/keynotes_L4_architect_2_monitoring_11_thanos.html" />
<meta property="og:site_name" content="cloudnative365.github.io" />
<script type="application/ld+json">
{"headline":"thanos","url":"http://localhost:4000/keynotes_L4_architect_2_monitoring_11_thanos.html","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=481468f1311b237dbb8ec4fec8c1099b04cbcc76">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">
      
      <h1><a href="http://localhost:4000/">cloudnative365.github.io</a></h1>
      

      <h2 id="1-概述">1. 概述</h2>

<h3 id="11-federation联邦">1.1. Federation（联邦）</h3>

<p>federation是prometheus的机制之一，主要是为了满足集群场景中高可用需求。但是他有一个致命的缺点，这个要从他federation的机制说起。我们先看图</p>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/Prometheus_federation.png" alt="See the source image" /></p>

<p>从图上可以看到，两台prometheus分别去采集4个分布在DC当中的prometheus的数据，在global的prometheus中我们应该这样配置</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- job_name: <span class="s1">'federate'</span>
  scrape_interval: 15s

  honor_labels: <span class="nb">true
  </span>metrics_path: <span class="s1">'/federate'</span>

  params:
    <span class="s1">'match[]'</span>:
      - <span class="s1">'{job="prometheus"}'</span>
      - <span class="s1">'{__name__=~"job:.*"}'</span>

  static_configs:
    - targets:
      - <span class="s1">'prometheus-ulsfo:9090'</span>
      - <span class="s1">'prometheus-codfw:9090'</span>
      - <span class="s1">'prometheus-eqiad:9090'</span>
      - <span class="s1">'prometheus-esams:9090'</span>
</code></pre></div></div>

<p>然后，大家想象一下这个场景，我们在前端使用grafana做展示，而grafana在选择数据源的时候只能选择一个地址，为了让prometheus集群中的两个实例都能够被grafana访问到，我们在prometheus之前配置了一个负载均衡器，比如nginx，让他监听在9090端口，使用nginx的反向代理功能，把请求代理至两个prometheus实例的9090端口上，实现了一定程度上的集群，如果一个prometheus实例挂了，那么，nginx会动态把这个后端摘掉，只把请求代理至另外一个实例。如果，过了一段时间，坏掉的实例恢复了，那么nginx会重新把这个实例加到集群中。这个时候，坏掉的prometheus在他坏掉的时候的数据是没办法收集到的。而这个时候nginx恰好把grafana的请求代理到了这个实例上，那么就会出现断点（gap）。</p>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/BqcdB.png" alt="gap" /></p>

<p>而这个问题，通过传统的架构是没办法解决的，我们需要借助其他的机制。</p>

<h3 id="12-持久存储">1.2. 持久存储</h3>

<p>使用过prometheus的朋友估计都知道，prometheus的数据并不是持久存储的，默认的retention参数<code class="highlighter-rouge">--storage.tsdb.retention.time</code>时间是15d。其实他还有很多别的机制比如文件大小<code class="highlighter-rouge">--storage.tsdb.retention.size</code>，这里就不详细说了。我们要说的是，prometheus本身是支持持久存储的。在<a href="https://prometheus.io/docs/operating/integrations/#remote-endpoints-and-storage">Integration</a>一章中有很多方式，他是通过remote write和remote read写入。他的本质是通过api的方式写入和读取，所以要求持久存储软件支持api方式写入。当然，也有Postgresql这种个例，是通过一个connector连接的。从节省的角度来说，我们可以选择只写的存储，比如ES，资料多，中文支持也好。如果是一个比较完整的方案，就要求读写。在云原生刚开始的时候，大家比较喜欢用clickhouse，因为他本身支持集群，还有人选择influxdb，因为他比较稳定。但是到了现在，我比较推荐cortex和thanos，因为这两个项目目前都是cncf的孵化项目，社区比较活跃，非常有潜力成为prometheus的流行发行版。</p>

<h3 id="13-thanos">1.3. Thanos</h3>

<p>最近很多朋友问我关于CNCF项目的分级问题，比如毕业的，孵化的或者沙箱的项目靠谱不靠谱。其实说实话，什么都靠谱什么都不靠谱。不靠谱是因为没有软件是完美的，即使商业软件也需要打补丁的。靠谱是因为软件的源代码开源，只要有开发能力，就没有办不成的事情。从另外一个角度来说，我们的k8s使用的注册中心etcd也是孵化软件，他本身也有很多的缺点。但是k8s一样风靡全世界，开源精神的另外一个境界就是他的不完美，不断的完善他才是开源精神的一种升华。</p>

<p>回头Thanos上，我们先来看一下thanos和prometheus的集成图</p>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200910100749148.png" alt="image-20200910100749148" /></p>

<p>从图中可以看到，原来prometheus是通过集中式的一个prometheus去采集各个集群中的prometheus数据，然后通过federation的方式进行整合的。而thanos是通过为prometheus附加一个sidecar，然后sidecar直接读取prometheus的数据然后整合再由thanos querier进行整合。</p>

<h2 id="2-快速搭建">2. 快速搭建</h2>

<p>最近Rancher Lab发了一篇<a href="https://mp.weixin.qq.com/s/E7fF0SKdrQhTESBD3cYTmw">文章</a>，我觉得写的是比较详细了，但是他的环境就让人望而却步，需要GKE，一个3节点k8s集群带ingress，还需要2个GCS存储桶。想还原这个真的需要投入很多。我们今天就使用1台机器进行demo，使用docker来隔离环境，使用MinIO来模拟S3存储桶。</p>

<h3 id="21-初始化prometheus环境">2.1. 初始化Prometheus环境</h3>

<p>我们假设有一个Prometheus服务器在EU1的集群环境。有两个Prometheus的实例在US1的集群中，抓取相同的目标</p>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911102235566.png" alt="image-20200911102235566" /></p>

<ul>
  <li>
    <p>prometheus的配置文件</p>

    <ul>
      <li>
        <p>EU1的配置文件prometheus0_eu1.yml</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: eu1
    replica: 0
    
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:9090'</span><span class="o">]</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>US1的配置文件prometheus0_us1.yml</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: us1
    replica: 0
    
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:9091'</span>,<span class="s1">'127.0.0.1:9092'</span><span class="o">]</span>
</code></pre></div>        </div>

        <p>US1的配置文件prometheus1_us1.yml</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: us1
    replica: 1
    
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:9091'</span>,<span class="s1">'127.0.0.1:9092'</span><span class="o">]</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>给prometheus准备数据文件的存储</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir <span class="nt">-p</span> /opt/<span class="o">{</span>prometheus0_eu1_data,prometheus0_us1_data,prometheus1_us1_data<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>部署EU1</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus0_eu1.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus0_eu1_data:/prometheus <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    <span class="nt">--name</span> prometheus-0-eu1 <span class="se">\</span>
    prom/prometheus:v2.14.0 <span class="se">\</span>
    <span class="nt">--config</span>.file<span class="o">=</span>/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--storage</span>.tsdb.path<span class="o">=</span>/prometheus <span class="se">\</span>
    <span class="nt">--web</span>.listen-address<span class="o">=</span>:9090 <span class="se">\</span>
    <span class="nt">--web</span>.enable-lifecycle <span class="se">\</span>
    <span class="nt">--web</span>.enable-admin-api
</code></pre></div>    </div>
  </li>
  <li>
    <p>部署US1</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus0_us1.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus0_us1_data:/prometheus <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    <span class="nt">--name</span> prometheus-0-us1 <span class="se">\</span>
    prom/prometheus:v2.14.0 <span class="se">\</span>
    <span class="nt">--config</span>.file<span class="o">=</span>/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--storage</span>.tsdb.path<span class="o">=</span>/prometheus <span class="se">\</span>
    <span class="nt">--web</span>.listen-address<span class="o">=</span>:9091 <span class="se">\</span>
    <span class="nt">--web</span>.enable-lifecycle <span class="se">\</span>
    <span class="nt">--web</span>.enable-admin-api
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus1_us1.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus1_us1_data:/prometheus <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    <span class="nt">--name</span> prometheus-1-us1 <span class="se">\</span>
    prom/prometheus:v2.14.0 <span class="se">\</span>
    <span class="nt">--config</span>.file<span class="o">=</span>/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--storage</span>.tsdb.path<span class="o">=</span>/prometheus <span class="se">\</span>
    <span class="nt">--web</span>.listen-address<span class="o">=</span>:9092 <span class="se">\</span>
    <span class="nt">--web</span>.enable-lifecycle <span class="se">\</span>
    <span class="nt">--web</span>.enable-admin-api
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="22-为prometheus附加sidecar">2.2. 为prometheus附加sidecar</h3>

<p>现在我们要为prometheus附加上sidecar了，只不过不是用pod方式，而是docker的–net方式模拟了一下sidecar</p>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911104548857.png" alt="image-20200911104548857" /></p>

<ul>
  <li>
    <p>为 EU1的prometheus添加sidecar</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus0_eu1.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--name</span> prometheus-0-sidecar-eu1 <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    quay.io/thanos/thanos:v0.13.0 <span class="se">\</span>
    sidecar <span class="se">\</span>
    <span class="nt">--http-address</span> 0.0.0.0:19090 <span class="se">\</span>
    <span class="nt">--grpc-address</span> 0.0.0.0:19190 <span class="se">\</span>
    <span class="nt">--reloader</span>.config-file /etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--prometheus</span>.url http://127.0.0.1:9090
</code></pre></div>    </div>
  </li>
  <li>
    <p>为US1的prometheus添加sidecar</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus0_us1.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--name</span> prometheus-0-sidecar-us1 <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    quay.io/thanos/thanos:v0.13.0 <span class="se">\</span>
    sidecar <span class="se">\</span>
    <span class="nt">--http-address</span> 0.0.0.0:19091 <span class="se">\</span>
    <span class="nt">--grpc-address</span> 0.0.0.0:19191 <span class="se">\</span>
    <span class="nt">--reloader</span>.config-file /etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--prometheus</span>.url http://127.0.0.1:9091
</code></pre></div>    </div>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">-v</span> /opt/prometheus1_us1.yml:/etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--name</span> prometheus-1-sidecar-us1 <span class="se">\</span>
    <span class="nt">-u</span> root <span class="se">\</span>
    quay.io/thanos/thanos:v0.13.0 <span class="se">\</span>
    sidecar <span class="se">\</span>
    <span class="nt">--http-address</span> 0.0.0.0:19092 <span class="se">\</span>
    <span class="nt">--grpc-address</span> 0.0.0.0:19192 <span class="se">\</span>
    <span class="nt">--reloader</span>.config-file /etc/prometheus/prometheus.yml <span class="se">\</span>
    <span class="nt">--prometheus</span>.url http://127.0.0.1:9092
</code></pre></div>    </div>
  </li>
  <li>
    <p>验证一下，由于sidecar的原因，我们在配置文件中修改的内容会直接体现到prometheus中</p>

    <ul>
      <li>
        <p>修改prometheus0_en1.yml</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: eu1
    replica: 0
    
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:9090'</span><span class="o">]</span>
  - job_name: <span class="s1">'sidecar'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:19090'</span><span class="o">]</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>修改prometheus0_us1.yml</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: us1
    replica: 0
    
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:9091'</span>,<span class="s1">'127.0.0.1:9092'</span><span class="o">]</span>
  - job_name: <span class="s1">'sidecar'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:19091'</span>,<span class="s1">'127.0.0.1:19092'</span><span class="o">]</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>修改prometheus1_us1.yml</p>

        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: us1
    replica: 1
    
scrape_configs:
  - job_name: <span class="s1">'prometheus'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:9091'</span>,<span class="s1">'127.0.0.1:9092'</span><span class="o">]</span>
  - job_name: <span class="s1">'sidecar'</span>
    static_configs:
      - targets: <span class="o">[</span><span class="s1">'127.0.0.1:19091'</span>,<span class="s1">'127.0.0.1:19092'</span><span class="o">]</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>验证</p>

    <ul>
      <li>
        <p>查看配置文件</p>

        <p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911110500231.png" alt="image-20200911110500231" /></p>
      </li>
      <li>
        <p>查看参数<code class="highlighter-rouge">thanos_sidecar_prometheus_up</code>,一定要保证sidecar是启用的状态</p>

        <p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911110530041.png" alt="image-20200911110530041" /></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="23-通过thanos查询">2.3. 通过Thanos查询</h3>

<p>我们现在添加一个thanos查询来整合我们的数据，架构如下</p>

<p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911111044507.png" alt="image-20200911111044507" /></p>

<ul>
  <li>
    <p>添加thanos querier</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-d</span> <span class="nt">--net</span><span class="o">=</span>host <span class="nt">--rm</span> <span class="se">\</span>
    <span class="nt">--name</span> querier <span class="se">\</span>
    quay.io/thanos/thanos:v0.13.0 <span class="se">\</span>
    query <span class="se">\</span>
    <span class="nt">--http-address</span> 0.0.0.0:29090 <span class="se">\</span>
    <span class="nt">--query</span>.replica-label replica <span class="se">\</span>
    <span class="nt">--store</span> 127.0.0.1:19190 <span class="se">\</span>
    <span class="nt">--store</span> 127.0.0.1:19191 <span class="se">\</span>
    <span class="nt">--store</span> 127.0.0.1:19192
</code></pre></div>    </div>
  </li>
  <li>
    <p>访问thanos的图形界面，和prometheus很像，但是多了几个功能</p>

    <ul>
      <li>
        <p>在查询的时候有去重功能</p>

        <p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911111805575.png" alt="image-20200911111805575" /></p>
      </li>
      <li>
        <p>还有一个new UI，这thanos自己做的，但是一样丑陋无比</p>

        <p><img src="/pages/keynotes/L4_architect/2_monitoring/pics/11_thanos/image-20200911111839473.png" alt="image-20200911111839473" /></p>
      </li>
    </ul>
  </li>
</ul>


      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
